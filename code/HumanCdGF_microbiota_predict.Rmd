---
title: "Predictions From Day 0 Community Structures"
author: "Nicholas Lesniak"
date: "July 13, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE}
if(!require(randomForest)) install.packages('randomForest', repos = 'http://cran.us.r-project.org')
library(randomForest)
if(!require(miscTools)) install.packages('miscTools', repos = 'http://cran.us.r-project.org')
library(miscTools)
if(!require(ggplot2)) install.packages('ggplot2', repos = 'http://cran.us.r-project.org')
library(ggplot2)
```

```{r, echo=FALSE}
setwd("~/Documents/Github/Schubert_humanCdGF_XXXX_2016")

#read in files
meta_file <- read.table('data/process/human_CdGF_metadata.txt', sep='\t',header = T, row.names = 'group')
shared_file <- read.table('data/process/human_CdGF.an.unique_list.0.03.subsample.shared', sep='\t',header = T, row.names='Group')

#### main subset of meta file with all mouse and day 0 info
day_0_meta <- meta_file[which(meta_file$day==0),!is.na(meta_file['430-307-D0',])]
day_0_meta$RowNames <- rownames(day_0_meta)
day_0_meta$Euth_Early <-ifelse(day_0_meta$Euthanized %in% 10, 'No','Yes')
####
#    function to move mouse data from rows by mouse and days --> rows by mouse and columns by days
####
# select data to move
cdiff_effect <- c("cdiff_cfu","percent_weightLoss.x","Log_repiricoal_dilution")
# function input meta_file as DATAFRAME and mouse dataframe as INPUT
combine_days_by_mouse <- function(DATAFRAME, INPUT){
          OUTPUT <- INPUT
     for(DAY in 1:10){
          NEW_ROW <- DATAFRAME[which(DATAFRAME$day==DAY),c(cdiff_effect, 'Mouse_ID')]
          names(NEW_ROW)[!names(NEW_ROW) %in% 'Mouse_ID'] <- 
               paste('Day_',paste(DAY,paste('_',names(NEW_ROW)[!names(NEW_ROW) %in% 'Mouse_ID'], sep=''), sep=''),sep='')
          OUTPUT <- merge(OUTPUT, NEW_ROW, by='Mouse_ID', all.x=TRUE)
     }
     return(OUTPUT)
}

test <- merge(day_0_meta,meta_file[which(meta_file$day==3),c(cdiff_effect, 'Mouse_ID')], by='Mouse_ID')

rf_meta_df <- combine_days_by_mouse(meta_file[!meta_file$sample_type=='cecum',], day_0_meta)
# remove all columns with no data - toxin missing from some days
rf_meta_df <- rf_meta_df[,colSums(is.na(rf_meta_df)) != nrow(rf_meta_df)]
# add columns for data from day euthanized
day_euthanized_cdiff <- meta_file[which(meta_file$sample_type=='stool' & meta_file$day == meta_file$Euthanized), c(cdiff_effect,'Mouse_ID')]
names(day_euthanized_cdiff)[!names(day_euthanized_cdiff) %in% 'Mouse_ID'] <- 
     paste('Day_Euth_',names(day_euthanized_cdiff)[!names(day_euthanized_cdiff) %in% 'Mouse_ID'], sep='')
rf_meta_df <- merge(rf_meta_df,day_euthanized_cdiff, by='Mouse_ID', all.x=TRUE)

#### subset shared
#Create df with relative abundances
day_0_shared <- shared_file[rownames(day_0_meta),]
rel_abund_day_0 <- 100*day_0_shared/unique(apply(day_0_shared, 1, sum))
#Create vector of OTUs with median abundances >1%
OTUs_day_0_01 <- apply(rel_abund_day_0, 2, max) > 1
#df of OTUs with abundances >1% - by cage and inoculum
rel_abund_day_0 <- rel_abund_day_0[,OTUs_day_0_01]
OTU_list <- names(rel_abund_day_0)

#Merge OTU data with mouse/exp data
Predict_df <- merge(rf_meta_df, rel_abund_day_0, by.x='RowNames', by.y='row.names')
Predict_df <- Predict_df[,!names(Predict_df) %in% c('Mouse_ID','RowNames','cage_id')]

#create function for random forest
run_rf_on <- function(DATAFRAME, RESPONSE, SAMPLE_SPLIT = 2/3,  OTUs = OTU_list){
set.seed(2)
     #
     Predictor_df <- as.data.frame(DATAFRAME[!DATAFRAME[,RESPONSE] %in% NA,c(RESPONSE,OTUs)])
     sample_set <- sample(seq_len(nrow(Predictor_df)), size = floor((SAMPLE_SPLIT)*nrow(Predictor_df)))
     test <- Predictor_df[-sample_set,]
     train <- Predictor_df[sample_set,] 
          RF <- randomForest(as.formula(paste(RESPONSE, '~ .')), data = train, importance = TRUE)
     R2 <- rSquared(test[,RESPONSE], test[,RESPONSE] - predict(RF,test))
     MSE <- mean((test[,RESPONSE] - predict(RF,test))^2)
     IMPORT <- importance(RF)
     FOREST <- RF
     PLOT<- ggplot(data = data.frame(actual=test[,RESPONSE],pred=predict(RF,test)),
       aes(x=actual, y=pred)) + geom_point() + geom_abline(color='red')
     ##MEAN_DECREASE <- varImpPlot(RF)
     return(list(rf=FOREST,r2=R2,mse=MSE,import=IMPORT,plot=PLOT))
}
```

##Can we predict the endpoint C. difficile CFU with the community structure at Day 0?
But endpoint has data from Day 2,3,10

Might be misleading since contains CFU from different data points
     
```{r, echo=FALSE}
Day_Euth_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_Euth_cdiff_cfu')
Day_Euth_cdiff_cfu_rf$plot
```

% Variance explained `r Day_Euth_cdiff_cfu_rf$rf$rsq[length(Day_Euth_cdiff_cfu_rf$rf$rsq)]*100`  
r^2^ = `r Day_Euth_cdiff_cfu_rf$r2`  
MSE = `r Day_Euth_cdiff_cfu_rf$mse`  

***

##Can we predict moribundity with the community structure at Day 0?
```{r, echo=FALSE}
##Fix to be categorical, and not regression
Predict_early_euth_df <- Predict_df[!Predict_df$Euth_Early %in% NA,c('Euth_Early',OTU_list)]
rf_early_euth <- randomForest(as.factor(Euth_Early) ~ ., data = Predict_early_euth_df)
rf_early_euth
```

##Can we predict the Day 10 C. difficile CFU with the community structure at Day 0?

```{r, echo=FALSE}
Day_10_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_10_cdiff_cfu')
Day_10_cdiff_cfu_rf$plot
```

% Variance explained `r Day_10_cdiff_cfu_rf$rf$rsq[length(Day_10_cdiff_cfu_rf$rf$rsq)]*100`

Why day 10? What is significant about day 10?

***

##Does Day 0 community structure predict the each day C. difficile CFU at a similar?

##Can we predict the Day 1 C. difficile CFU with the community structure at Day 0?

```{r,echo=FALSE}
#rf to predict 
Day_1_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_1_cdiff_cfu')
Day_1_cdiff_cfu_rf$plot
```

% Variance explained `r Day_1_cdiff_cfu_rf$rf$rsq[length(Day_1_cdiff_cfu_rf$rf$rsq)]*100`

# Day 2 C. difficile CFU
```{r, echo=FALSE}
Day_2_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_2_cdiff_cfu')
Day_2_cdiff_cfu_rf$plot
```

% Variance explained `r Day_2_cdiff_cfu_rf$rf$rsq[length(Day_2_cdiff_cfu_rf$rf$rsq)]*100`

# Day 3 C. difficile CFU
```{r, echo=FALSE}
Day_3_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_3_cdiff_cfu')
Day_3_cdiff_cfu_rf$plot
```

% Variance explained `r Day_3_cdiff_cfu_rf$rf$rsq[length(Day_3_cdiff_cfu_rf$rf$rsq)]*100`

# Day 4 C. difficile CFU
```{r, echo=FALSE}
Day_4_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_4_cdiff_cfu')
Day_4_cdiff_cfu_rf$plot
```

% Variance explained `r Day_4_cdiff_cfu_rf$rf$rsq[length(Day_4_cdiff_cfu_rf$rf$rsq)]*100`

# Day 5 C. difficile CFU
```{r, echo=FALSE}
Day_5_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_5_cdiff_cfu')
Day_5_cdiff_cfu_rf$plot
```

% Variance explained `r Day_5_cdiff_cfu_rf$rf$rsq[length(Day_5_cdiff_cfu_rf$rf$rsq)]*100`

# Day 6 C. difficile CFU
```{r, echo=FALSE}
Day_6_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_6_cdiff_cfu')
Day_6_cdiff_cfu_rf$plot
```

% Variance explained `r Day_6_cdiff_cfu_rf$rf$rsq[length(Day_6_cdiff_cfu_rf$rf$rsq)]*100`

# Day 7 C. difficile CFU
```{r, echo=FALSE}
Day_7_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_7_cdiff_cfu')
Day_7_cdiff_cfu_rf$plot
```

% Variance explained `r Day_7_cdiff_cfu_rf$rf$rsq[length(Day_7_cdiff_cfu_rf$rf$rsq)]*100`

# Day 8 C. difficile CFU
```{r, echo=FALSE}
Day_8_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_8_cdiff_cfu')
Day_8_cdiff_cfu_rf$plot
```

% Variance explained `r Day_8_cdiff_cfu_rf$rf$rsq[length(Day_8_cdiff_cfu_rf$rf$rsq)]*100`

# Day 9 C. difficile CFU
```{r, echo=FALSE}
Day_9_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_9_cdiff_cfu')
Day_9_cdiff_cfu_rf$plot
```

% Variance explained `r Day_9_cdiff_cfu_rf$rf$rsq[length(Day_9_cdiff_cfu_rf$rf$rsq)]*100`

# Day 10 C. difficile CFU
```{r, echo=FALSE}
Day_10_cdiff_cfu_rf <- run_rf_on(Predict_df,'Day_10_cdiff_cfu')
Day_10_cdiff_cfu_rf$plot
```

% Variance explained `r Day_10_cdiff_cfu_rf$rf$rsq[length(Day_10_cdiff_cfu_rf$rf$rsq)]*100`


Predicting CFU from day 1 to 10 based on Day 0 community

There seems a flucuation in the % variance explained, which seems to coincide with the fluctuations in cdiff cfu  

##seed greatly affects variance, likely due to data split, sample size might be too small to make reliable predictions


```{r knitr::kable, echo=FALSE, warning=F, message=F}
var_by_day <- data.frame(Day=c(1:10),Percent_Variance_Explained=NA)
cdiff_cfu <- vector()
for (a in 1:10){
          var_by_day$Percent_Variance_Explained[a] <- eval(parse(text = paste('Day_', a, '_cdiff_cfu_rf$rf$rsq[length(Day_', a, '_cdiff_cfu_rf$rf$rsq)]*100', sep='')))
          cdiff_cfu <- c(cdiff_cfu,paste('Day_', a, '_cdiff_cfu', sep=''))
     }

knitr::kable(var_by_day)
plot(var_by_day, type='n', xlab='Day',ylab='Percent Var Explained')
lines(var_by_day$Day, var_by_day$Percent_Variance_Explained)

cfu_plot <- cbind(Mouse = paste(Predict_df$human_source,Predict_df$mouse_eartag, sep='_'),Predict_df[, cdiff_cfu])
names(cfu_plot) <- c('Mouse', c(1:10))
cfu_plot <- reshape2::melt(cfu_plot, by='Mouse')

ggplot(data=cfu_plot, aes(x=variable, y=value, group=Mouse)) + geom_line(aes(color=Mouse)) + geom_point() + scale_y_log10() +
     theme_classic() + theme(legend.position='none') + labs(title='C. Difficile CFU by mouse',x='Day',y='CFU')
```

***
***

##Can we predict day 1 weight change with the community structure at Day 0?
```{r, echo=FALSE}

```

##Can we predict day 10 weight change with the community structure at Day 0?
```{r, echo=FALSE}

```

##Can we predict ___________ with the community structure at Day 0?
```{r, echo=FALSE}

```
