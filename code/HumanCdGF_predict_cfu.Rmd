---
title: "humanCdGF_predict_cfu"
author: "Nicholas Lesniak"
date: "October 7, 2016"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, fig.width=7, fig.height=8)
```

```{r setup environment}
pack_used <- c('randomForest','miscTools','tidyr','ggplot2','dplyr', 'pROC', 'knitr', 'cowplot')
for (dep in pack_used){
  if (dep %in% installed.packages()[,"Package"] == FALSE){
    install.packages(as.character(dep), repos = 'http://cran.us.r-project.org', 
                     quiet=TRUE);
  }
  library(dep, verbose=FALSE, character.only=TRUE)
}
```

```{r setup data}
# read in files
meta_data   <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/human_CdGF_metadata.txt'
shared_file <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/human_CdGF.an.unique_list.0.03.subsample.shared'
tax_file <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/mothur/gf_all.an.cons.taxonomy'
tax_function <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/code/tax_level.R'

# read in files
meta_data   <- read.table(meta_data, sep = '\t', header = T)
shared_file <- read.table(shared_file, sep = '\t', header = T, row.names = 'sample_id')
tax_file <- read.table(tax_file, sep = '\t', header = T, row.names = 'OTU')
source(tax_function)

# remove samples not used or with other cdiff strains
meta_file <- 
  meta_data %>% 
  filter(Early_Euth == FALSE, cdiff_strain == 431, !cage_id == 'NP1') %>% 
  select(mouse_id, sample_id, day, log_cfu) %>% 
  filter(!is.na(log_cfu))

shared_list_days <- select(meta_file, -log_cfu)

# create shared with relative abundances over 1%
mean_otu_counts <- unique(apply(shared_file, 1, sum))
rel_abund_shared <- 100 * shared_file / mean_otu_counts
rel_abund_shared_01 <- rel_abund_shared[ , apply(rel_abund_shared, 2, max) > 1]
rel_abund_shared_01$sample_id <- rownames(rel_abund_shared_01)

seed <- 1
n_trees <- 1001
rf_plot_list <- list()
n_features <- 10
cutoff <- 30

heat.plot <- function(input_maxtrix, high_color = '#660000', low_color = '#FFFFFF', legend_title = NA) {
  long.df <- data.frame(input_maxtrix)
  colnames(long.df) <- c(1:10)
  long.df$community_day <- as.character(c(0:10))
  long.df %>% gather(cfu_day, variable, -community_day) %>% 
    ggplot(aes(cfu_day, community_day)) + 
    geom_tile(aes(fill = variable), color = 'white') +
    scale_fill_gradient(low = low_color, high = high_color, name = legend_title, limits = c(0,1)) +
    labs(x = 'Day (CFU)', y = 'Day (Community)') + 
    theme(axis.line.x = element_blank(), axis.line.y = element_blank(), axis.ticks = element_blank()) + 
    scale_x_discrete(expand = c(0, 0), limits = c('1','2','3','4','5','6','7','8','9','10')) + 
    scale_y_discrete(expand = c(0, 0), limits = rev(c('0','1','2','3','4','5','6','7','8','9','10'))) + 
    theme(legend.position = 'top', legend.key.width = unit(2, 'cm'))
}
```

```{r functions}
rsq <- matrix(NA, nrow = 11, ncol = 10)
mse <- matrix(NA, nrow = 11, ncol = 10)
otu_votes <- rep(0, ncol(rel_abund_shared_01))
names(otu_votes) <- colnames(rel_abund_shared_01)
importance.df <- c()
for(m in 0:10){
  sample_list <- shared_list_days %>% 
    filter(day == m) %>% 
    select(-day)
  community.df <- rel_abund_shared_01 %>% 
    right_join(sample_list) %>% 
    select(-sample_id)
    for(n in 1:10){
      cfu_shared.df <- meta_file %>% 
        filter(day == n) %>% 
        select(mouse_id, log_cfu) %>% 
        right_join(community.df) %>% 
        select(-mouse_id) %>% 
        filter(!is.na(log_cfu))

      set.seed(seed)
      rf_all <- randomForest(log_cfu ~ ., data = cfu_shared.df,
                           importance = TRUE, ntree = n_trees)
      importance_sorted <- sort(importance(rf_all)[,1], decreasing = T)
      top_important_OTU <- rownames(data.frame(head(importance_sorted, n_features)))
      set.seed(seed)
      rf_n_features <- randomForest(log_cfu ~ ., data=cfu_shared.df[ ,c( 'log_cfu',
                                                                 names(importance_sorted)[1:n_features])], 
                                  importance=TRUE, ntree=n_trees)
      rsq[m+1, n] <- round(tail(rf_n_features$rsq, 1), 2)
      mse[m+1, n] <- round(tail(rf_n_features$mse, 1), 2)
      otu_votes <- otu_votes + 1*(colnames(rel_abund_shared_01) %in% top_important_OTU)
      importance.df <- rbind(importance.df, c(RSQ = round(tail(rf_n_features$rsq, 1), 2), 
                      MSE = round(tail(rf_n_features$mse, 1), 2),
                      importance(rf_all)[,1]/max(importance(rf_all)[,1])))
    }
  }

importance.df <- data.frame(importance.df)
import_features <- importance.df[importance.df$RSQ >= 0.6 & importance.df$MSE <= 0.8, ]
import_features <- import_features[ , !colnames(import_features) %in% c('RSQ','MSE')]
med_import_feat <- apply(import_features, 2, median)
otus_above_20 <- import_features[,names(med_import_feat)[med_import_feat >= 0.2]]
top_n_overall <- names(otu_votes)[otu_votes >= cutoff]

rsq_n <- matrix(NA, nrow = 11, ncol = 10)
mse_n <- matrix(NA, nrow = 11, ncol = 10)
otu_votes_n <- rep(0, ncol(rel_abund_shared_01))
names(otu_votes_n) <- colnames(rel_abund_shared_01)

for(m in 0:10){
  sample_list <- shared_list_days %>% 
    filter(day == m) %>% 
    select(-day)
  community.df <- rel_abund_shared_01 %>% 
    right_join(sample_list) %>% 
    select(-sample_id)
  for(n in 1:10){
    cfu_shared.df <- meta_file %>% 
      filter(day == n) %>% 
      select(mouse_id, log_cfu) %>% 
      right_join(community.df) %>% 
      select(log_cfu, one_of(top_n_overall)) %>% 
      filter(!is.na(log_cfu))
    
    set.seed(seed)
    rf_all <- randomForest(log_cfu ~ ., data = cfu_shared.df,
                           importance = TRUE, ntree = n_trees)
    importance_sorted <- sort(importance(rf_all)[,1], decreasing = T)
    top_important_OTU <- rownames(data.frame(head(importance_sorted, n_features)))
    set.seed(seed)
    rf_n_features <- randomForest(log_cfu ~ ., data=cfu_shared.df[ ,c( 'log_cfu',
                                                                       names(importance_sorted)[1:n_features])], 
                                  importance=TRUE, ntree=n_trees)
    rsq_n[m+1, n] <- round(tail(rf_n_features$rsq, 1), 2)
    mse_n[m+1, n] <- round(tail(rf_n_features$mse, 1), 2)
    otu_votes_n <- otu_votes_n + 1*(colnames(rel_abund_shared_01) %in% top_important_OTU)
  }
}
taxa <- get_tax(1, names(otu_votes_n[otu_votes_n >= 1]), tax_file)
taxa_names <- paste0(taxa$tax, ' (', gsub('tu0*', 'TU ', rownames(taxa)),')')
```

### OTUs selected by >`r cutoff`% of models generated by all OTU models 
###### Using the following bacteria: `r taxa_names`

```{r top otus, fig.width=6, fig.height=6}
heat.plot(rsq_n, '#003300', legend_title = expression(paste('R'^'2')))
#plot(otu_votes_n[otu_votes_n >= 1], xlab = 'OTU', ylab = 'Freq')
```

### CFU and Rel abundance plots

```{r fig.height=5, fig.width=8}
meta_data %>% 
  filter(!is.na(day), !cage_id == 'NP1', 
         Early_Euth == FALSE, cdiff_strain == 431) %>% 
  ggplot(aes(x = factor(day), y = log_cfu, color = cage_id)) + 
    geom_line(aes(group = mouse_id), size=.25, alpha=0.4) + geom_point() +
    stat_summary(fun.y=mean, geom="line", aes(group = cage_id)) + 
    theme_bw() + labs(x = 'Day', y = 'C Diff CFU (log10)') +
    theme(legend.justification=c(1,0), legend.position=c(1,0), 
          legend.title=element_blank())
```

How does removing the low samples (Day 8 and CFUs around 0) affect prediction?

```{r identify reason for lowered R2, fig.height=5, fig.width=8}
log_cutoff <- 2.5

meta_data %>% 
  filter(!sample_id == 'OUT2-2533-D8', log_cfu >= log_cutoff) %>% 
  filter(!is.na(day), !cage_id == 'NP1', 
         Early_Euth == FALSE, cdiff_strain == 431) %>% 
  ggplot(aes(x = factor(day), y = log_cfu, color = cage_id)) + 
    geom_line(aes(group = mouse_id), size=.25, alpha=0.4) + geom_point() +
    stat_summary(fun.y=mean, geom="line", aes(group = cage_id)) + 
    theme_bw() + labs(x = 'Day', y = 'C Diff CFU (log10)') +
    theme(legend.justification=c(1,0), legend.position=c(1,0), 
          legend.title=element_blank()) + scale_y_continuous(limits = c(0,9))

meta_reduced <- meta_data %>% 
  filter(!sample_id == 'OUT2-2533-D8', log_cfu >= log_cutoff) %>% 
  filter(Early_Euth == FALSE, cdiff_strain == 431, !cage_id == 'NP1') %>% 
  select(mouse_id, sample_id, day, log_cfu) %>% 
  filter(!is.na(log_cfu))

rsq_r <- matrix(NA, nrow = 11, ncol = 10)
otu_votes_r <- rep(0, ncol(rel_abund_shared_01))
names(otu_votes_r) <- colnames(rel_abund_shared_01)

for(m in 0:10){
  sample_list <- shared_list_days %>% 
    filter(day == m) %>% 
    select(-day)
  community.df <- rel_abund_shared_01 %>% 
    right_join(sample_list) %>% 
    select(-sample_id)
  for(n in 1:10){
    cfu_shared.df <- meta_reduced %>% 
      filter(day == n) %>% 
      select(mouse_id, log_cfu) %>% 
      right_join(community.df) %>% 
      select(log_cfu, one_of(top_n_overall)) %>% 
      filter(!is.na(log_cfu))
    
    set.seed(seed)
    rf_top <- randomForest(log_cfu ~ ., data = cfu_shared.df,
                           importance = TRUE, ntree = n_trees)
    importance_sorted <- sort(importance(rf_top)[,1], decreasing = T)
    top_important_OTU <- rownames(data.frame(head(importance_sorted, n_features)))
    set.seed(seed)
    rf_n_features <- randomForest(log_cfu ~ ., data=cfu_shared.df[ ,c( 'log_cfu',
                                                                       names(importance_sorted)[1:n_features])], 
                                  importance=TRUE, ntree=n_trees)
    importance_final <- sort(importance(rf_n_features)[,1], decreasing = T)
    top_OTU_final <- rownames(data.frame(head(importance_final, n_features)))
    rsq_r[m+1, n] <- round(tail(rf_n_features$rsq, 1), 2)
    otu_votes_r <- otu_votes_r + 1*(colnames(rel_abund_shared_01) %in% top_OTU_final)
  }
}
taxa_r <- get_tax(1, names(otu_votes_r[otu_votes_r >= 1]), tax_file)
taxa_names_r <- paste0(taxa$tax, ' (', gsub('tu0*', 'TU ', rownames(taxa)),')')
```

```{r fig.width=6,fig.height=6}
heat.plot(rsq_r, '#003300', legend_title = expression(paste('R'^'2')))
```

Removing these data points improves predictability for day 6 and 8 but not the earlier days. If I increase the cutoff to remove all CFU below 5, there is a slight increase in day 3 cfu classification at the cost of decrease day 1 cfu classification.

### Is there any abnormalities in the OTUs of any these days?

```{r plot features,fig.width=8, fig.height=20}
meta_data %>% 
  filter(!sample_id == 'OUT2-2533-D8', log_cfu >= log_cutoff) %>% 
  filter(!cage_id == 'NP1', Early_Euth == FALSE, cdiff_strain == 431) %>% 
  full_join(rel_abund_shared_01) %>% 
  select(day, sample_id, mouse_id, cage_id, 
         one_of(names(otu_votes_r[otu_votes_r >= 1]))) %>% 
  gather(otu, rel_abund, Otu00002:Otu00250) %>% 
  filter(!is.na(day)) %>% 
  ggplot(aes(x=factor(day),y=rel_abund, color = cage_id)) +
    geom_line(aes(group = mouse_id), size=.25, alpha=0.4) + geom_point() +
    stat_summary(fun.y=mean, geom="line", aes(group = cage_id)) + 
    facet_grid(otu ~., scales='free_y') +
    theme_bw() + labs(x = 'Day', y = 'Relative Abundance (%)')
```

### Does taking the median CFU improve predicatbility?

```{r predict median CFU heatmap, fig.width=6,fig.height=6}


rsq_med <- matrix(NA, nrow = 11, ncol = 10)
otu_votes_med <- rep(0, ncol(rel_abund_shared_01))
names(otu_votes_med) <- colnames(rel_abund_shared_01)
for(n in 1:10){
med_log_cfu <- meta_data %>% 
  filter(day %in% c(n:10), !cage_id == 'NP1', 
         Early_Euth == FALSE, cdiff_strain == 431) %>% 
  select(mouse_id, cage_id, log_cfu) %>% 
  group_by(mouse_id, cage_id) %>% 
  summarise(log_cfu_med = median(log_cfu)) %>% ungroup()
for(m in 0:10){
  sample_list <- shared_list_days %>% 
    filter(day == m) %>% 
    select(-day)
  community.df <- rel_abund_shared_01 %>% 
    right_join(sample_list) %>% 
    select(-sample_id)
  cfu_shared.df <- med_log_cfu %>% 
      select(mouse_id, log_cfu_med) %>% 
      right_join(community.df) %>% 
      select(-mouse_id) %>% 
#      select(log_cfu_med, one_of(top_n_overall)) %>% 
      filter(!is.na(log_cfu_med))
    set.seed(seed)
    rf_top <- randomForest(log_cfu_med ~ ., data = cfu_shared.df,
                           importance = TRUE, ntree = n_trees)
    importance_sorted <- sort(importance(rf_top)[,1], decreasing = T)
    top_important_OTU <- rownames(data.frame(head(importance_sorted, n_features)))
    set.seed(seed)
    rf_n_features <- randomForest(log_cfu_med ~ ., data=cfu_shared.df[ ,c( 'log_cfu_med',
                                                                       names(importance_sorted)[1:n_features])], 
                                  importance=TRUE, ntree=n_trees)
    importance_final <- sort(importance(rf_n_features)[,1], decreasing = T)
    top_OTU_final <- rownames(data.frame(head(importance_final, n_features)))
    rsq_med[m+1, n] <- round(tail(rf_n_features$rsq, 1), 2)
    otu_votes_med <- otu_votes_med + 1*(colnames(rel_abund_shared_01) %in% top_OTU_final)
}
}

heat.plot(rsq_med, '#003300', legend_title = expression(paste('R'^'2'))) + 
  ggtitle('Day CFU is median value of Day n to Day 10')

```


### Reframing the question for predicting CFU
#### 1. Can Day 0 community predict the median steady-state-colonized CFU?

```{r predict median CFU, fig.width=10,fig.height=10}

Cage_dep_df <- meta_data %>% 
  filter(day == 0) %>% 
  select(human_source, sample_id, cage_id) %>% 
  left_join(rel_abund_shared_01)
Predict_cage_df <- select(Cage_dep_df, -human_source, -sample_id)
Predict_source_df <- select(Cage_dep_df, -cage_id, -sample_id)
Predict_cage_df$cage_id <- factor(Predict_cage_df$cage_id)
Predict_source_df$human_source <- factor(Predict_source_df$human_source)

# identify OTUs that predict cage/inocula
set.seed(seed)
rf_cage <- randomForest(cage_id ~ ., data=Predict_cage_df, importance=TRUE, ntree=n_trees)
set.seed(seed)
rf_source <- randomForest(human_source ~ ., data=Predict_source_df, importance=TRUE, ntree=n_trees)
features_source <- head(sort(rf_source$importance[ , 'MeanDecreaseAccuracy'], decreasing = T), 65)
features_cage <- head(sort(rf_cage$importance[ , 'MeanDecreaseAccuracy'], decreasing = T), 65)
cage_source_features <- unique(c(names(features_cage), names(features_source)))


colonized_cfu <- meta_data %>% 
  filter(day %in% c(4:10), !cage_id == 'NP1', 
         Early_Euth == FALSE, cdiff_strain == 431) %>% 
  select(mouse_id, cage_id, log_cfu) %>% 
  group_by(mouse_id, cage_id) %>% 
  summarise(log_cfu_med = median(log_cfu)) %>% 
  ungroup()
sample_list_d0 <- shared_list_days %>% 
    filter(day == 0) %>% 
    select(-day)
community_d0.df <- rel_abund_shared_01 %>% 
    right_join(sample_list_d0) %>% 
    select(-sample_id)
cfu_shared_colonized.df <- colonized_cfu %>% 
    right_join(community_d0.df) %>% 
    select(-mouse_id, -cage_id, -one_of(cage_source_features)) %>% 
    filter(!is.na(log_cfu_med))

set.seed(seed)
rf_all <- randomForest(log_cfu_med ~ ., data = cfu_shared_colonized.df,
                           importance = TRUE, ntree = n_trees, mtry = 14)

importance_sorted <- sort(importance(rf_all)[,1], decreasing = T)
top_important_OTU <- rownames(data.frame(importance_sorted[importance_sorted/max(importance_sorted) > 0.6]))

top_colonized_df <- data.frame(cfu_shared_colonized.df %>% 
  select(log_cfu_med, one_of(top_important_OTU)))

set.seed(seed)
rf_n_features <- randomForest(log_cfu_med ~ ., data=top_colonized_df,
                              importance=TRUE, ntree=n_trees, mtry = 2,
                              keep.forest=TRUE)

importance_final <- sort(importance(rf_n_features)[,1], decreasing = T)

rf_prediction <- data.frame(observed = cfu_shared_colonized.df$log_cfu_med, 
                       predicted = rf_n_features$predicted)
rf_prediction <- merge(rf_prediction, colonized_cfu, by.x = 'observed', by.y = 'log_cfu_med')

ggplot(data = rf_prediction, aes(x=observed, y=predicted, color = cage_id)) + geom_point() + 
  labs(x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)',
       title = "Random Forest Prediction of Colonized C Difficile CFU from Day 0 Community") + 
  theme_bw() + xlim(0,9) + ylim(0,9) + 
  annotate('text', x=0.15*(max(rf_prediction$observed)), 
           y=0.95*(max(rf_prediction$predicted)), 
           label=paste0('R^2 = ', round(tail(rf_n_features$rsq, 1), 2)))

importance.df <- data.frame(otu = names(importance_final),
                            importance = importance_final,
                            tax = get_tax(1, names(importance_final), tax_file))
tax_label <- paste0(importance.df$tax, ' (', 
                    gsub('tu0*', 'TU ', importance.df$otu), 
                    ') : ', 
                    round(importance.df$importance, 3))

layout(matrix(c(1:9), ncol=3, byrow=TRUE))

cage_color <- rainbow(length(unique(rf_prediction$cage_id)))
for (i in seq_along(importance_final)) {
  partial_otu <- 
    partialPlot(rf_n_features, top_colonized_df, names(importance_final)[i],
                xlab='', main=paste(tax_label[i]), 
                ylim = c(min(top_colonized_df$log_cfu_med),max(top_colonized_df$log_cfu_med)))
  for(m in seq_along(unique(rf_prediction$cage_id))){
    cage <- unique(rf_prediction$cage_id)[m]
    points(y = top_colonized_df[rf_prediction$cage_id %in% cage, 'log_cfu_med'],
         x = top_colonized_df[rf_prediction$cage_id %in% cage , names(importance_final)[i]], 
         pch = 21, bg = cage_color[m])
  }
}
```


#### 2. Can Day 0 community predict the rate of colonization?

```{r predict colonization rate, fig.width=10,fig.height=10}

meta_data %>% 
  filter(!is.na(day), !cage_id == 'NP1', 
         Early_Euth == FALSE, cdiff_strain == 431) %>% 
  ggplot(aes(x = factor(day), y = log_cfu, color = cage_id)) + 
    geom_line(aes(group = mouse_id), size=.25, alpha=0.4) + geom_point() +
    stat_summary(fun.y=mean, geom="line", aes(group = cage_id)) + 
    theme_bw() + labs(x = 'Day', y = 'C Diff CFU (log10)') +
    theme(legend.justification=c(1,0), legend.position=c(1,0), 
          legend.title=element_blank())

mouse_list <- meta_data %>% 
  filter(!is.na(day), !cage_id == 'NP1', 
         Early_Euth == FALSE, cdiff_strain == 431) %>% 
  select(mouse_id) %>% 
  unique()
mouse_list <- as.character(mouse_list$mouse_id)

col_rate <- c()
for(i in mouse_list){
  test <- meta_data %>% 
    filter(!is.na(day), mouse_id == i) %>% 
    select(day, log_cfu) %>% 
    filter(!is.na(log_cfu))
  if(1 %in% test$day){
    colonization_ratio <- test[test$day==1, 'log_cfu']/median(head(sort(test$log_cfu, decreasing = T),3))
  } else {
    colonization_ratio <- median(head(test[order(test$day), "log_cfu"],2))/
                            median(head(sort(test$log_cfu, decreasing = T),3))
  }
  col_rate <- rbind(col_rate, c(mouse_id = i,  ratio = colonization_ratio))
}

col_rate <- data.frame(mouse_id = col_rate[ , 1], ratio = as.numeric(col_rate[ , 2]))

col_rate <- meta_data %>% 
  select(mouse_id, cage_id) %>% 
  unique() %>% 
  right_join(col_rate)

shared_col_rate.df <- col_rate %>% 
    right_join(community_d0.df) %>% 
    select(-one_of(cage_source_features))
shared_colonized.df <- select(shared_col_rate.df, -mouse_id, -cage_id)


set.seed(seed)
rf_col_rate <- randomForest(ratio ~ ., data = shared_colonized.df,
                           importance = TRUE, ntree = n_trees, mtry = 14)

importance_sorted <- sort(importance(rf_col_rate)[,1], decreasing = T)
top_important_OTU <- rownames(data.frame(importance_sorted[importance_sorted/max(importance_sorted) > 0.6]))

top_col_rate_df <- data.frame(shared_colonized.df %>% 
  select(ratio, one_of(top_important_OTU)))

set.seed(seed)
rf_col_rate_features <- randomForest(ratio ~ ., data=top_col_rate_df,
                              importance=TRUE, ntree=n_trees, mtry = 2,
                              keep.forest=TRUE)

importance_final <- sort(importance(rf_col_rate_features)[,1], decreasing = T)

rf_col_rate_prediction <- data.frame(observed = shared_colonized.df$ratio, 
                       predicted = rf_col_rate_features$predicted)
rf_cr_prediction <- cbind(cage_id = shared_col_rate.df[,'cage_id'], rf_col_rate_prediction)
  
ggplot(data = rf_cr_prediction, aes(x=observed, y=predicted, color = cage_id)) + geom_point() + 
  labs(x= 'Observed', y = 'Predicted',
       title = "Random Forest Prediction of Relative Colonization level of C Difficile from Day 0 Community") + 
  theme_bw() + xlim(0,1) + ylim(0,1) + 
  annotate('text', x=0.15*(max(rf_cr_prediction$observed)), 
           y=0.95*(max(rf_cr_prediction$predicted)), 
           label=paste0('R^2 = ', round(tail(rf_col_rate_features$rsq, 1), 2)))

importance.df <- data.frame(otu = names(importance_final),
                            importance = importance_final,
                            tax = get_tax(1, names(importance_final), tax_file))
tax_label <- paste0(importance.df$tax, ' (', 
                    gsub('tu0*', 'TU ', importance.df$otu), 
                    ') : ', 
                    round(importance.df$importance, 3))

layout(matrix(c(1:9), ncol=3, byrow=TRUE))

cage_color <- rainbow(length(unique(rf_cr_prediction$cage_id)))
for (i in seq_along(importance_final)) {
  partial_otu <- 
    partialPlot(rf_col_rate_features, top_col_rate_df, names(importance_final)[i],
                xlab='', main=paste(tax_label[i]), 
                ylim = c(min(top_col_rate_df$ratio),max(top_col_rate_df$ratio)))
  for(m in seq_along(unique(rf_cr_prediction$cage_id))){
    cage <- unique(rf_cr_prediction$cage_id)[m]
    points(y = top_col_rate_df[rf_cr_prediction$cage_id %in% cage, 'ratio'],
         x = top_col_rate_df[rf_cr_prediction$cage_id %in% cage , names(importance_final)[i]], 
         pch = 21, bg = cage_color[m])
  }
}

```

Does not predict colonization rate as well  
  - could be due to removed (cage/inocula-sensitive) otus  
  - improper measurement of colonization rate  
  - colonization rate not microbiome dependent, may be dependent on host factors of acute infection

***  
  
***  

###### Re-runnning the program and only focusing on the OTUs predicting day 9/10 to see if there is consistence in the predictive features gives the following selection  (including all samples):  
Otu00004 Otu00005 Otu00015 Otu00019 Otu00030 Otu00199 Otu00200 Otu00250   
      14       17       13       15       13       16       17       19
      
```{r boruta feature selection, eval = F}
bor_all <- c()

for(m in 0:10){
  sample_list <- shared_list_days %>% 
    filter(day == m) %>% 
    select(-day)
  community.df <- rel_abund_shared_01 %>% 
    right_join(sample_list) %>% 
    select(-sample_id)
    for(n in 9:10){
      cfu_shared.df <- meta_file %>% 
        filter(day == n) %>% 
        select(mouse_id, log_cfu) %>% 
        right_join(community.df) %>% 
        select(-mouse_id) %>% 
        filter(!is.na(log_cfu))

      set.seed(seed)
      bor_all[[(m*2)+(n-8)]] <- Boruta(log_cfu ~ ., data = cfu_shared.df, maxRuns = 2000)
    }
  }

boruta.votes <- rep(0, ncol(rel_abund_shared_01))
names(boruta.votes) <- colnames(rel_abund_shared_01)
for(i in 1:22){
  boruta.votes <- boruta.votes + 1*(bor_all[[i]]$finalDecision   == 'Confirmed')
}
plot(boruta.votes)
boruta.votes[boruta.votes >= 16]

colnames(otus_above_20)
```

Boruta Confirmed the following OTUs as important for predicting day 9/10 cfu:   
Otu00004 Otu00005 Otu00015 Otu00030 Otu00081 Otu00199 Otu00200 Otu00250 Otu00297  
      21       22       21       21       21       22       22       22       20  

Selecting OTUs through collecting the features from the most predictive community/cfu models (R^2 >= 0.6 and MSE <= 0.8), then converting all % Increase in MSE to relative values and taking the median value of of each OTU, then selecting OTUs that fall above the median value results in the following OTUs:  
"Otu00001" "Otu00002" "Otu00004" "Otu00005" "Otu00012" "Otu00014" "Otu00015" "Otu00016" "Otu00019" "Otu00028" "Otu00030" "Otu00048" "Otu00081" "Otu00101" "Otu00118" "Otu00199" "Otu00200" "Otu00250" "Otu00297"
```{r }