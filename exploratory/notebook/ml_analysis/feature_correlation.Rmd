---
title: "feature_correlation_notebook"
author: "Nick Lesniak"
date: "6/16/2021"
output:
  rmarkdown::github_document: default
  pdf_document: default
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_knit$set(root.dir = '../../..')
```

```{r setup data}
library(tidyverse)

performance_df <- read_tsv('../../../data/process/ml/ml_performance.tsv',
                     col_type = 'dddddddddddddddcdcc') %>% 
  mutate(dataset = factor(dataset, c('same_day_toxin', 'day_0_predict_future_toxin',
                                     'day_0_moribund', 'day_10_histology')),
         taxonomic_level = factor(taxonomic_level, 
                                  levels = c('OTU', 'Genus', 'Family', 'Order', 'Class', 'Phylum')))  
features_df <- read_tsv('../../../data/process/ml/ml_feature_imp.tsv',
                     col_type = 'ddcccdcc') 
hyperparameter_df <- read_tsv('../../../data/process/ml/ml_hp_performance.tsv',
                     col_type = 'ddcdccc') 
taxonomy_df <- read_tsv('../../../data/process/final.taxonomy.tidy.tsv',
                        col_type = cols(.default = col_character()))

metadata <- read_tsv('../../../data/process/metadata_tidy.tsv',
					 col_type = 'cccccDddddDcdddddcdl') %>% 
	filter(cdiff_strain == 431) %>% 
	mutate(cdiff_cfu = ifelse(cdiff_cfu == 0, log10(60), log10(cdiff_cfu)))

toxin <- read_tsv('../../../data/process/toxin_tidy.tsv',
				  col_type = 'cccccdc') %>% 
	mutate(toxin = ifelse(Log_repiricoal_dilution > 1, 'present', 'absent'))

histology <- read_tsv('../../../data/process/histology_tidy.tsv',
					  col_type = 'ccccdddcdcc') %>% 
	mutate(hist_score = case_when(summary_score < 5 ~ 'low',
								  summary_score > 5 ~ 'high',
								  summary_score == 5 ~ 'mid',
								  T ~ 'NA'))

shared <- read_tsv('../../../data/mothur/sample.final.0.03.subsample.shared',
         col_types = cols(.default = col_double(),
                          Group = col_character())) %>% 
  mutate(Group = ifelse(grepl('_D|DA', Group), Group,
      gsub('D', '_D', Group))) %>% 
  select(-label, -numOtus)

same_day_toxin_df <- toxin %>% 
	select(group, toxin) %>% 
	inner_join(shared, by = c('group' = 'Group')) %>% 
	left_join(select(metadata, group, C_difficile_CFU = cdiff_cfu), by = c('group'))

#	from day 0?
day_0_predict_future_toxin_df <- toxin %>% 
	group_by(mouse_id) %>% 
	summarise(toxin = ifelse(max(Log_repiricoal_dilution) > 1, 'present', 'absent')) %>% 
	left_join(select(metadata, mouse_id, day, group), 
			  by = c('mouse_id')) %>% 
	filter(day == 0) %>% 
	inner_join(shared, by = c('group' = 'Group'))

# setup data to predict moribunidty (microbiome, cdiff, toxin)
toxin_summary <- toxin %>% 
	filter(toxin_sample_day  %in% c(1,2)) %>% 
	group_by(mouse_id) %>% 
	summarise(toxin_positive_days = sum(Log_repiricoal_dilution > 1))
cfu_summary <- metadata %>% 
	filter(day %in% c(1,2)) %>% 
	group_by(mouse_id, early_euth) %>% 
	summarise(median_CFU = median(cdiff_cfu))
day_0_moribund <- metadata %>% 
	select(group, mouse_id, day) %>% 
	filter(day == 0) %>% 
	left_join(cfu_summary, by = c('mouse_id')) %>% 
	left_join(toxin_summary, by = c('mouse_id')) %>% 
	inner_join(shared, by = c('group' = 'Group')) %>% 
	mutate(early_euth = ifelse(early_euth, 'severe', 'mild'))

# setup data to predict histology severity of colonized mice (microbiome, cdiff, toxin)
day_10_histology_df <- metadata %>% 
	filter(day == 10,
		early_euth == F) %>% 
	select(group, C_difficile_CFU = cdiff_cfu, mouse_id) %>% 
	left_join(select(toxin, group, toxin_level = Log_repiricoal_dilution),
		by = c('group')) %>% 
	inner_join(shared, by = c('group' = 'Group')) %>% 
	inner_join(select(histology, mouse_id, hist_score), by = c('mouse_id')) 
```



```{r}
performance_df %>% 
  filter(dataset == 'day_0_predict_future_toxin',
         method == 'rf') %>% 
  select(method, seed, dataset, cv_auc = cv_metric_AUC, test_auc = AUC, taxonomic_level) %>% 
  pivot_longer(cols = c(cv_auc, test_auc), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  mutate(taxonomic_level = factor(taxonomic_level, 
                                  levels = c('OTU', 'Genus', 'Family', 'Order', 'Class', 'Phylum'))) %>% 
  ggplot(aes(x = taxonomic_level, y = Performance, color = metric)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~method, scales = 'free_y') + 
    theme_bw()
```


Using RF at the Phylum level the features with median differences greater than 0 are:


```{r}
day_0_toxin_production <- features_df %>% 
  filter(dataset == 'day_0_predict_future_toxin',
         (method == 'rf' & taxonomic_level == 'Phylum')) %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0) 
day_0_toxin_production %>%
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    #geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset, scales= 'free_y', space = 'free_y') + 
    labs(x = NULL, y = 'Decrease AUC') +
    theme_bw()
```


#### Verrucomicrobia (Akkermansia) has a median decrease in AUC of 0.12

Using RF at the Genus level the features with median differences greater than 0 are:


```{r}
day_0_toxin_production <- features_df %>% 
  filter(dataset == 'day_0_predict_future_toxin',
         (method == 'rf' & taxonomic_level == 'Genus')
         ) %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff),
         n = length(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0,
         n > 1) %>% 
  left_join(select(taxonomy_df, Genus, Phylum), by = c('names' = 'Genus')) %>% 
  mutate(names = paste(names, '(', Phylum, ')'))
day_0_toxin_production %>%
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    #geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset, scales= 'free_y', space = 'free_y') + 
    labs(x = NULL, y = 'Decrease AUC') +
    theme_bw()
```

#### Akkermansia now has a median decrease in AUC of less than 0.005  
  
    
runnning my model at all taxa levels, Verrucomicrobia (akkermansia) is top feature with median decrease in AUC of 0.12 for phylum but at the genus level it drops to 0.005 but both models overall perform the same. only one genus correlates close to akkermansia (0.8) but has low effect on auc. so i was trying to think if its possible another set of features could be replace the information lost by akkermansia, but unsure how to show or evaluate that possibility  
-  run ml to predict akkermansia  
-  add multiple genera together and check for correlation between akkermansia and combined genera sets  
-  compare distibution of abundance relative to outcome  
  
  
Are other genera or combinations of genera able to replace signal from akkermansia? 

```{r}
corr_df <- day_0_predict_future_toxin_df %>% 
  pivot_longer(cols = starts_with('Otu'), names_to = 'OTU', values_to = 'counts') %>% 
  left_join(taxonomy_df, by = "OTU") %>% 
  group_by(group, toxin, Genus) %>% 
  summarise(counts = sum(counts)/21.07) %>% 
  group_by(Genus) %>% 
  mutate(max = max(counts)) %>% 
  filter(max > 0) %>% 
  ungroup
akk_df <- corr_df %>% 
  filter(Genus == 'Akkermansia') %>% 
  pull(counts)

#corr_df %>% 
#  group_by(Genus) %>% 
#  nest() %>% 
#  mutate(pvalue = map(data, function(x) cor.test(akk_df, x$counts, method = 'pearson')$p.value),         
#         corr = map(data, function(x) cor.test(akk_df, x$counts, method = 'pearson')$estimate)
#         ) %>% 
#  unnest(pvalue, corr) %>% 
#  filter(!is.na(pvalue)) %>% 
#  arrange(desc(abs(corr))) %>% 
#	mutate(pvalue_BH = p.adjust(pvalue, method = 'BH', n = nrow(.))) %>% 
#  filter(pvalue_BH< 0.05)
```
  Correlation with Akkermansia
  
    
|Feature|P value| Rho|  
|-----------------|-----|-----|  
|Akkermansia | 0.00e00	| 1.00 |  
|Rubneribacter | 1.50e-12	| 0.812 |  

  



Try combining features and then testing correlations w/ Akkermansia  

```{r}
#output <- c()
#for(i in corr_df$Genus){
#  for(j in corr_df$Genus){
#    comparison <- paste(i, j, sep = '_')
#    comparison_values <- pull(filter(corr_df, Genus == i), counts) + pull(filter(corr_df, Genus == j), counts)
#    correlation_output <- cor.test(akk_df, comparison_values, method = 'pearson')
#    output <- bind_rows(output, tibble(feature = comparison, 
#                                       pvalue = correlation_output$p.value, 
#                                       correlation = correlation_output$estimate))
#  }
#}
#
#tail(output)
#output %>% 
#  filter(correlation < -0.5 | correlation > 0.5) %>% 
#  distinct %>% 
#  filter(!grepl('Akkermansia', feature),
#         !grepl('Rubneribacter', feature))
```

Correlation to Akkermansia (only running up to the combination of  Ileibacterium_Rikenellaceae_unclassified)

|Feature|P value| Rho|  
|-----------------|-----|-----|  
|Alloiococcus | 1.412915e-03	| 0.443538316 |  
|Enterobacterales_unclassified | 1.027612e-01	| 0.235874618 |  
|Alloiococcus_Enterobacterales_unclassified | 0.0002539063	| 0.5000263 |  
  
  
Could the effect in decrease AUC be due to the number of features being much larger than the number of samples?  
  
This model has 49 samples  
-  the phylum level model has 11 features  
-  the genus level model has 111 features  
    
The literature suggests as few as 5 samples/feature but Ploeg et al says 20-50 samples/feature for LR and >200 was insufficient in some cases for RF, but LR can use penalization to reduce the number of features
https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-14-137





```{r, eval=F}

day_0_toxin_production <- features_df %>% 
  filter(dataset == 'day_0_predict_future_toxin',
         method == 'glmnet' & taxonomic_level == 'Genus') %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0) 
day_0_toxin_production %>%
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    #geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset, scales= 'free_y', space = 'free_y') + 
    labs(x = NULL, y = 'Decrease AUC') +
    theme_bw()
```



```{r, eval =F}
day_0_toxin_production <- features_df %>% 
  filter(dataset == 'day_0_predict_future_toxin',
         method == 'glmnet' & taxonomic_level == 'Family') %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0) 
day_0_toxin_production %>%
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    #geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset, scales= 'free_y', space = 'free_y') + 
    labs(x = NULL, y = 'Decrease AUC') +
    theme_bw()

```