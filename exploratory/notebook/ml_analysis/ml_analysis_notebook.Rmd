---
title: "ml_output_notebook"
author: "Nick Lesniak"
date: "5/21/2021"
output: rmarkdown::github_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_knit$set(root.dir = '../../..')
```


```{r read in data}
library(tidyverse)

# load in hyperparameter/training data
training_frac_df <- map_dfr(c(50, 60, 70, 80, 90), function(x){
  read_tsv(
      paste0('../../../data/process/ml/training_frac/combined_ml_performance_', x, '.tsv'),
      col_type = 'dddddddddddddddcdc') %>% 
    mutate(training_frac = x/100)
})

training_frac_hp_df <- map_dfr(c(50, 60, 70, 80, 90), function(x){
  read_tsv(
      paste0('../../../data/process/ml/training_frac/combined_ml_hp_performance_', x, '.tsv'),
      col_type = 'ddcdcc') %>% 
    mutate(training_frac = x/100)
})
```


## Hyperparameter Performance

```{r}
training_frac_df %>% 
  select(method, seed, dataset, cv_auc = cv_metric_AUC, test_auc = AUC, training_frac) %>% 
  pivot_longer(cols = c(cv_auc, test_auc), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  mutate(dataset = factor(dataset, c('same_day_toxin', 'day_0_predict_future_toxin',
                                     'day_0_moribund', 'day_10_histology'))) %>% 
  ggplot(aes(x = method, y = Performance, color = metric)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~training_frac) + 
    theme_bw() + 
    coord_flip()


```


```{r}
training_frac_hp_df %>% 
  filter(model == 'glmnet') %>% 
  mutate(dataset = factor(dataset, c('same_day_toxin', 'day_0_predict_future_toxin',
                                     'day_0_moribund', 'day_10_histology'))) %>% 
    ggplot(aes(x = value, y = AUC, color = params)) + 
    geom_point(alpha = 0.25)+ 
    stat_summary(fun = median, geom = 'line') + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~training_frac, scales = 'free_x') + 
    theme_bw() + 
    scale_x_log10()

training_frac_hp_df %>% 
  filter(model == 'rf') %>% 
  mutate(dataset = factor(dataset, c('same_day_toxin', 'day_0_predict_future_toxin',
                                     'day_0_moribund', 'day_10_histology'))) %>% 
  ggplot(aes(x = value, y = AUC, color = params)) + 
    geom_point(alpha = 0.25)+ 
    stat_summary(fun = median, geom = 'line') + 
    ylim(c(0.5,1)) + 
    facet_grid(dataset~training_frac, scales = 'free') + 
    theme_bw()
```


## Model Performance


Features  
-  same day toxin presence - CFU, taxonomic abundances  
-  day 0 future toxin presence - taxonomic abundances  
-  day 0 future moribund - median cfu, day w/toxin presence (prior to day 3), taxonomic abundances  
      to avoid duplicating similar data, i sumarized cfu/toxin to be a single feature to represent the amount or presence over the first two days of challenge since all mice were present for at least 2 days
-  day 10 histology (high/mid/low) - cfu, toxin level, taxonomic abundances  

```{r}

performance_df <- read_tsv('../../../data/process/ml/ml_performance.tsv',
                     col_type = 'dddddddddddddddcdcc') %>% 
  mutate(dataset = factor(dataset, c('same_day_toxin', 'day_0_predict_future_toxin',
                                     'day_0_moribund', 'day_10_histology')),
         taxonomic_level = factor(taxonomic_level, 
                                  levels = c('OTU', 'Genus', 'Family', 'Order', 'Class', 'Phylum')))  
features_df <- read_tsv('../../../data/process/ml/ml_feature_imp.tsv',
                     col_type = 'ddcccddcc') 
hyperparameter_df <- read_tsv('../../../data/process/ml/ml_hp_performance.tsv',
                     col_type = 'ddcdccc') 
taxonomy_df <- read_tsv('../../../data/process/final.taxonomy.tidy.tsv',
                        col_type = cols(.default = col_character()))

metadata <- read_tsv('../../../data/process/metadata_tidy.tsv',
					 col_type = 'cccccDddddDcdddddcdl') %>% 
	filter(cdiff_strain == 431) %>% 
	mutate(cdiff_cfu = ifelse(cdiff_cfu == 0, log10(60), log10(cdiff_cfu)))

toxin <- read_tsv('../../../data/process/toxin_tidy.tsv',
				  col_type = 'cccccdc') %>% 
	mutate(toxin = ifelse(Log_repiricoal_dilution > 1, 'present', 'absent'))

histology <- read_tsv('../../../data/process/histology_tidy.tsv',
					  col_type = 'ccccdddcdcc') %>% 
	mutate(hist_score = case_when(summary_score < 5 ~ 'low',
								  summary_score > 5 ~ 'high',
								  summary_score == 5 ~ 'mid',
								  T ~ 'NA'))

shared <- read_tsv('../../../data/mothur/sample.final.0.03.subsample.shared',
         col_types = cols(.default = col_double(),
                          Group = col_character())) %>% 
  mutate(Group = ifelse(grepl('_D|DA', Group), Group,
      gsub('D', '_D', Group))) %>% 
  select(-label, -numOtus)

same_day_toxin_df <- toxin %>% 
	select(group, toxin) %>% 
	inner_join(shared, by = c('group' = 'Group')) %>% 
	left_join(select(metadata, group, C_difficile_CFU = cdiff_cfu), by = c('group'))

#	from day 0?
day_0_predict_future_toxin_df <- toxin %>% 
	group_by(mouse_id) %>% 
	summarise(toxin = ifelse(max(Log_repiricoal_dilution) > 1, 'present', 'absent')) %>% 
	left_join(select(metadata, mouse_id, day, group), 
			  by = c('mouse_id')) %>% 
	filter(day == 0) %>% 
	inner_join(shared, by = c('group' = 'Group'))

# setup data to predict moribunidty (microbiome, cdiff, toxin)
toxin_summary <- toxin %>% 
	filter(toxin_sample_day  %in% c(1,2)) %>% 
	group_by(mouse_id) %>% 
	summarise(toxin_positive_days = sum(Log_repiricoal_dilution > 1))
cfu_summary <- metadata %>% 
	filter(day %in% c(1,2)) %>% 
	group_by(mouse_id, early_euth) %>% 
	summarise(median_CFU = median(cdiff_cfu))
day_0_moribund <- metadata %>% 
	select(group, mouse_id, day) %>% 
	filter(day == 0) %>% 
	left_join(cfu_summary, by = c('mouse_id')) %>% 
	left_join(toxin_summary, by = c('mouse_id')) %>% 
	inner_join(shared, by = c('group' = 'Group')) %>% 
	mutate(early_euth = ifelse(early_euth, 'severe', 'mild'))

# setup data to predict histology severity of colonized mice (microbiome, cdiff, toxin)
day_10_histology_df <- metadata %>% 
	filter(day == 10,
		early_euth == F) %>% 
	select(group, C_difficile_CFU = cdiff_cfu, mouse_id) %>% 
	left_join(select(toxin, group, toxin_level = Log_repiricoal_dilution),
		by = c('group')) %>% 
	inner_join(shared, by = c('group' = 'Group')) %>% 
	inner_join(select(histology, mouse_id, hist_score), by = c('mouse_id')) 
```



```{r}
performance_df %>% 
  select(method, seed, dataset, cv_auc = cv_metric_AUC, test_auc = AUC, taxonomic_level) %>% 
  pivot_longer(cols = c(cv_auc, test_auc), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  ggplot(aes(x = taxonomic_level, y = Performance, color = metric)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~method, scales = 'free_y') + 
    theme_bw() 
```
  
```{r}
hyperparameter_df %>% 
  filter(model == 'glmnet') %>% 
  ggplot(aes(x = value, y = AUC, color = taxonomic_level)) + 
    geom_point(alpha = 0.25) + 
    stat_summary(fun = median, geom = 'line') + 
    ylim(c(0.5,1)) + 
    facet_grid(dataset~taxonomic_level, scales = 'free') + 
    theme_bw() + 
    scale_x_log10()

```



```{r}
hyperparameter_df %>% 
  filter(model == 'rf') %>% 
  ggplot(aes(x = value, y = AUC, color = taxonomic_level)) + 
    geom_point(alpha = 0.25) + 
    stat_summary(fun = median, geom = 'line') + 
    ylim(c(0.5,1)) + 
    facet_grid(dataset~taxonomic_level, scales = 'free') + 
    theme_bw() + 
    scale_x_log10()

```

## Models and features


#### Modeling future production of toxin based on initial community  

```{r}
performance_df %>% 
  filter(dataset == 'day_0_predict_future_toxin') %>% 
  select(method, seed, dataset, cv_auc = cv_metric_AUC, test_auc = AUC, taxonomic_level) %>% 
  pivot_longer(cols = c(cv_auc, test_auc), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  mutate(taxonomic_level = factor(taxonomic_level, 
                                  levels = c('OTU', 'Genus', 'Family', 'Order', 'Class', 'Phylum'))) %>% 
  ggplot(aes(x = taxonomic_level, y = Performance, color = metric)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~method, scales = 'free_y') + 
    theme_bw() +
    geom_rect(data = data.frame(ymin = 0.35, ymax = 0.98, method = 'glmnet', taxonomic_level = 2, Performance = 1),
              aes(xmin = taxonomic_level - 0.5, xmax = taxonomic_level + 0.5, ymin = ymin, ymax = ymax, color = NA), 
              fill = NA) +
    geom_rect(data = data.frame(ymin = 0.48, ymax = 0.99, method = 'rf', taxonomic_level = 6, Performance = 1),
              aes(xmin = taxonomic_level - 0.5, xmax = taxonomic_level + 0.5, ymin = ymin, ymax = ymax, color = NA), 
              fill = NA)
```


Using Logistic regression at the Genus level or RF at the Phylum level the features with median differences greater than 0 are:


```{r}
day_0_toxin_production <- features_df %>% 
  filter(dataset == 'day_0_predict_future_toxin',
         (method == 'rf' & taxonomic_level == 'Phylum')# | (method == 'glmnet' & taxonomic_level == 'Genus')
         ) %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0) 
day_0_toxin_production %>%
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    #geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset, scales= 'free_y', space = 'free_y') + 
    labs(x = NULL, y = 'Decrease AUC') +
    theme_bw()
```


```{r}
day_0_toxin_features <- day_0_toxin_production %>% 
  select(names, median_diff) %>% 
  unique %>% 
  arrange(median_diff) %>% 
  pull(names)

day_0_predict_future_toxin_df %>% 
  pivot_longer(cols = starts_with('Otu'), names_to = 'OTU', values_to = 'counts') %>% 
  left_join(taxonomy_df, by = "OTU") %>% 
  filter(Phylum %in% day_0_toxin_features) %>% 
  group_by(group, toxin, Phylum) %>% 
  summarise(counts = sum(counts)/21.07) %>% 
  mutate(Phylum = factor(Phylum, day_0_toxin_features)) %>% 
  ggplot(aes(x = Phylum, y = counts, color = toxin)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5),
                 position = position_dodge(width = 0.7)) +
    geom_jitter(position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.3), 
                alpha = 0.2) + 
    scale_y_log10() + 
    theme_bw() + 
    coord_flip() + 
    scale_color_manual(values = c('red', 'black'),
                       breaks = c('absent', 'present'), 
                       labels = c('False', 'True')) + 
    labs(x = NULL, y = 'Relative Abundance (%)', color  = 'Toxin Detected')
  
```

#### Modeling production of toxin with the community and CFU data from that same day

```{r}
performance_df %>% 
  filter(dataset == 'same_day_toxin') %>% 
  select(method, seed, dataset, cv_auc = cv_metric_AUC, test_auc = AUC, taxonomic_level) %>% 
  pivot_longer(cols = c(cv_auc, test_auc), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  ggplot(aes(x = taxonomic_level, y = Performance, color = metric)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~method, scales = 'free_y') + 
    theme_bw() +
    geom_rect(data = data.frame(ymin = 0.7, ymax = 0.95, method = 'glmnet', taxonomic_level = 6, Performance = 1),
              aes(xmin = taxonomic_level - 0.5, xmax = taxonomic_level + 0.5, ymin = ymin, ymax = ymax, color = NA), 
              fill = NA)
```


Using Logistic regression at the Phylum level the features with median differences greater than 0 are:


```{r}

same_day_toxin <- features_df %>% 
  filter(dataset == 'same_day_toxin',
         method == 'glmnet',
         taxonomic_level == 'Phylum') %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0) 
same_day_toxin %>%   
  ggplot(aes(x = reorder(names, median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    coord_flip() + 
    facet_grid(method~dataset) + 
    labs(x = NULL, y = 'AUC Diff with feature permuted') +
    theme_bw()

```



```{r}
same_day_toxin_features <- same_day_toxin %>% 
  select(names, median_diff) %>% 
  unique %>% 
  arrange(median_diff) %>% 
  pull(names)

same_day_toxin_df %>% 
  ggplot(aes(x = toxin, y = C_difficile_CFU, color = toxin)) + 
    geom_jitter(alpha = 0.2, width  = 0.3) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5),
                 position = position_dodge(width = 0.7)) +
    coord_flip() + 
    theme_bw() + 
    labs(x = NULL, y = 'C. difficile CFU', color  = 'Toxin Detected')
```





```{r}
same_day_toxin_df %>% 
  pivot_longer(cols = starts_with('Otu'), names_to = 'OTU', values_to = 'counts') %>% 
  left_join(taxonomy_df, by = "OTU") %>% 
  filter(Phylum %in% same_day_toxin_features) %>% 
  group_by(group, toxin, Phylum) %>% 
  summarise(counts = sum(counts)/21.07) %>% 
  mutate(Phylum = factor(Phylum, same_day_toxin_features)) %>% 
  ggplot(aes(x = Phylum, y = counts, color = toxin)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5),
                 position = position_dodge(width = 0.7)) +
    geom_jitter(position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.3), 
                alpha = 0.05) + 
    scale_y_log10() + 
    theme_bw() + 
    coord_flip() + 
    scale_color_manual(values = c('red', 'black'),
                       breaks = c('absent', 'present'), 
                       labels = c('False', 'True')) + 
    labs(x = NULL, y = 'Relative Abundance (%)', color  = 'Toxin Detected')
  
```

#### Modeling severe disease (moribund) from the initial community

```{r}
performance_df %>% 
  filter(dataset == 'day_0_moribund') %>% 
  select(method, seed, dataset, cv_auc = cv_metric_AUC, test_auc = AUC, taxonomic_level) %>% 
  pivot_longer(cols = c(cv_auc, test_auc), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  mutate(taxonomic_level = factor(taxonomic_level, 
                                  levels = c('OTU', 'Genus', 'Family', 'Order', 'Class', 'Phylum'))) %>% 
  ggplot(aes(x = taxonomic_level, y = Performance, color = metric)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(dataset~method, scales = 'free_y') + 
    theme_bw() +
    geom_rect(data = data.frame(ymin = 0.65, ymax = 1.01, method = 'glmnet', taxonomic_level = 5, Performance = 1),
              aes(xmin = taxonomic_level - 0.5, xmax = taxonomic_level + 0.5, ymin = ymin, ymax = ymax, color = NA), 
              fill = NA)
```


Using Logistic regression at the Class level the features with median differences greater than 0 are:


```{r}
day_0_moribund_plot_df <- features_df %>% 
  filter(dataset == 'day_0_moribund',
         method == 'glmnet',
         taxonomic_level == 'Class') %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0) 
day_0_moribund_plot_df %>% 
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    #geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset) + 
    labs(x = NULL, y = 'AUC Diff with feature permuted') +
    theme_bw()
```


```{r}
day_0_moribund_features <- day_0_moribund_plot_df %>% 
  select(names, median_diff) %>% 
  unique %>% 
  arrange(median_diff) %>% 
  pull(names)

day_0_moribund %>% 
  pivot_longer(cols = starts_with('Otu'), names_to = 'OTU', values_to = 'counts') %>% 
  left_join(taxonomy_df, by = "OTU") %>% 
  filter(Class %in% day_0_moribund_features) %>% 
  group_by(group, early_euth, Class) %>% 
  summarise(counts = sum(counts)/21.07) %>% 
  mutate(Phylum = factor(Class, day_0_moribund_features)) %>% 
  ggplot(aes(x = Phylum, y = counts, color = early_euth)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5),
                 position = position_dodge(width = 0.7)) +
    geom_jitter(position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.3), 
                alpha = 0.2) + 
    scale_y_log10() + 
    theme_bw() + 
    coord_flip() + 
#    scale_color_manual(values = c('red', 'black'),
 #                      breaks = c('absent', 'present'), 
  #                     labels = c('False', 'True')) + 
    labs(x = NULL, y = 'Relative Abundance (%)', color  = 'Disease Severity')
  
```



#### Modeling endpoint histology scores
  
    
```{r}
hist_performance_df <- read_tsv('../../../data/process/ml/hist_ml_performance.tsv')
hist_features_df <- read_tsv('../../../data/process/ml/hist_ml_feature_imp.tsv') 
hist_hyperparameter_df <- read_tsv('../../../data/process/ml/hist_ml_hp_performance.tsv') 

hist_performance_df %>% 
  select(method, seed, dataset, training =cv_metric_logLoss, test = logLoss, taxonomic_level, null_model) %>% 
  pivot_longer(cols = c(training, test), 
               names_to = 'metric', 
               values_to = 'Performance') %>% 
  mutate(metric = ifelse(grepl('NULL', dataset), paste0(metric, '_NULL'), metric)) %>% 
  ggplot(aes(x = taxonomic_level, y = Performance, color = metric)) + 
    geom_boxplot() + 
    #geom_hline(yintercept = 0.5, linetype = 'dashed', size = 0.25) +
    facet_grid(.~method, scales = 'free_y') + 
    theme_bw() + 
    coord_cartesian(ylim = c(0,2)) +
    labs(x = NULL, y = 'Performance - logLoss') + 
    geom_rect(data = data.frame(ymin = 0.1, ymax = 0.93, method = 'rf', taxonomic_level = 6, Performance = 1),
              aes(xmin = taxonomic_level - 0.5, xmax = taxonomic_level + 0.5, ymin = ymin, ymax = ymax, color = NA), 
              fill = NA)
# helpful logloss explanation https://stats.stackexchange.com/questions/276067/whats-considered-a-good-log-loss
```

  
Using multiclass RF at the Phylum level the features with median differences greater than 0 are:

 
```{r}
hist_features_plot_df <- hist_features_df %>% 
  filter(dataset == 'day_10_histology',
         method == 'rf',
         taxonomic_level == 'Phylum') %>% 
  group_by(names) %>% 
  mutate(median_diff = median(perf_metric_diff)) %>% 
  ungroup() %>% 
  filter(median_diff > 0)
hist_features_plot_df %>% 
  ggplot(aes(x = reorder(names,median_diff), y = perf_metric_diff)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5)) +
    geom_jitter(alpha = 0.1, width = 0.1) + 
    coord_flip() + 
    facet_grid(method~dataset) + 
    labs(x = NULL, y = 'AUC Diff with feature permuted') + 
    theme_bw()
    
```


```{r}
hist_features <- hist_features_plot_df %>% 
  select(names, median_diff) %>% 
  unique %>% 
  arrange(median_diff) %>% 
  pull(names)

day_10_histology_df %>% 
  pivot_longer(cols = starts_with('Otu'), names_to = 'OTU', values_to = 'counts') %>% 
  left_join(taxonomy_df, by = "OTU") %>% 
  filter(Phylum %in% hist_features) %>% 
  group_by(group, hist_score, Phylum) %>% 
  summarise(counts = sum(counts)/21.07) %>% 
  mutate(Phylum = factor(Phylum, hist_features),
         hist_score = factor(hist_score, c('low', 'mid', 'high'))) %>% 
  ggplot(aes(x = Phylum, y = counts, color = hist_score)) + 
    stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5),
                 position = position_dodge(width = 0.7)) +
    geom_jitter(position = position_jitterdodge(dodge.width = 0.9, jitter.width = 0.3), 
                alpha = 0.2) + 
    scale_y_log10() + 
    theme_bw() + 
    coord_flip() + 
#    scale_color_manual(values = c('red', 'black'),
 #                      breaks = c('absent', 'present'), 
  #                     labels = c('False', 'True')) + 
    labs(x = NULL, y = 'Relative Abundance (%)', color  = 'Histology Score')
  
```