---
title: "Model_CFU"
author: "Nicholas Lesniak"
date: "December 5, 2016"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, fig.width=7, fig.height=8)
```

```{r setup environment}
pack_used <- c('randomForest','tidyr','ggplot2','plyr', 'dplyr', 'caret')
for (dep in pack_used){
  if (dep %in% installed.packages()[,"Package"] == FALSE){
    install.packages(as.character(dep), repos = 'http://cran.us.r-project.org', 
                     quiet=TRUE);
  }
  library(dep, verbose=FALSE, character.only=TRUE)
}
```

```{r setup data}
# read in files
setwd('~/Documents/Github/Schubert_humanCdGF_XXXX_2016/')
meta_data   <- 'data/process/human_CdGF_metadata.txt'
shared_file <- 'data/process/human_CdGF.an.unique_list.0.03.subsample.shared'
tax_file <- 'data/process/gf_new.an.taxonomy'
tax_function <- 'code/tax_level.R'

# read in files
meta_data   <- read.table(meta_data, sep = '\t', header = T, stringsAsFactors = F)
shared_file <- read.table(shared_file, sep = '\t', header = T, row.names = 'sample_id')
tax_file <- read.table(tax_file, sep = '\t', header = T, row.names = 'OTU')
source(tax_function)

# set parameters
seed <- 1
#n_trees <- 1001
#n_otus <- 12
#iters <- 100
#cor_cutoff <- 0.75
otu_presence_cutoff <- 0.1

# remove samples not used or with other cdiff strains
meta_data <- 
  meta_data %>% 
  filter(Early_Euth == FALSE, cdiff_strain == 431, !cage_id == 'NP1') %>% 
  select(mouse_id, sample_id, cage_id, human_source, day, log_cfu) %>% 
  filter(!is.na(log_cfu))
shared_list_days <- meta_data %>% 
  filter(day == 0) %>% 
  select(-day, -log_cfu, -cage_id, -human_source)
shared_file <- shared_file[rownames(shared_file) %in% shared_list_days$sample_id, ]

# create shared with relative abundances over 1%
mean_otu_counts <- unique(apply(shared_file, 1, sum))
otu_presence <- ifelse(shared_file > 0, T, F) 
rel_abund_shared <- shared_file[ , apply(otu_presence, 2, sum) > round(otu_presence_cutoff*nrow(shared_file))]
rel_abund_shared_01 <- 100*rel_abund_shared/mean_otu_counts

n_features <- round(0.1*ncol(rel_abund_shared))

## remove correlative otus
#rel_abund_cor <- cor(rel_abund_shared_01, method = 'spearman')
#rownames(rel_abund_cor) <- colnames(rel_abund_shared_01) # add row names to identify otus correlated with features
#cor_otus <- findCorrelation(rel_abund_cor, cutoff = cor_cutoff)
#rel_abund_01_filtr <- rel_abund_shared_01[,-cor_otus]
#community_d0.df <- merge(shared_list_days, rel_abund_01_filtr, 
#                         by.x = 'sample_id', by.y = 'row.names') %>% 
#                    select(-sample_id)

colonized_cfu <- meta_data %>% 
  filter(day %in% c(4:10)) %>% 
  group_by(mouse_id, cage_id, human_source) %>% 
  summarise(log_cfu_med = median(log_cfu)) %>% 
  ungroup()

community_all_d0 <- merge(shared_list_days, rel_abund_shared_01, 
                          by.x = 'sample_id', by.y = 'row.names') %>% 
                     select(-sample_id)
```

### Predicting Colonization Level (Log10 CFU) with Day 0 Community

```{r predict median CFU, fig.width=10,fig.height=10}
cfu_all_shared_df <- colonized_cfu %>% 
    select(mouse_id, log_cfu_med) %>% 
    right_join(community_all_d0) %>% 
    select(-mouse_id) %>% 
    filter(!is.na(log_cfu_med))

#output <- data.frame(ntree = NA, ntry = NA, rsq = NA)
#for(tree in seq(1, 1500, 100)){
#  for(try in 1:30){
#    set.seed(seed)
#    cfu_all_rf <- randomForest(cfu_all_shared_df[ , -1], cfu_all_shared_df$log_cfu_med,
#                           ntree = tree,
#                           mtry = try,
#                           importance = T)
#    output <- rbind(output, c(tree, try, tail(cfu_all_rf$rsq, 1)))
#  }
#}
#
#ggplot(output[output$ntree !=1,], aes(x=ntree, y=rsq, group = ntry, color = as.factor(ntry))) + geom_line()
#ggplot(output[output$ntree == 1001,], aes(x=ntry, y=rsq)) + geom_line()

set.seed(seed)
cfu_all_rf <- randomForest(cfu_all_shared_df[ , -1], cfu_all_shared_df$log_cfu_med,
                           ntree = 1001,
                           mtry = 15,
                           importance = T)
top_features <- head(sort(importance(cfu_all_rf)[,1],decreasing = T), n_features)
feat_cor_cfu <- cor(cfu_all_shared_df[ , c('log_cfu_med', 
                                           names(top_features))],
                    method = 'spearman')[-1,'log_cfu_med']
```

#### Predictive OTUs  
##### OTUs predictive of _Colonization level_ (Top 10%)  
Model built using all OTUs present in >10% of samples, only displaying top 10% of predictive features

```{r prediction cfu plot, fig.width=6, fig.height=6}

data.frame(Observed = cfu_all_shared_df$log_cfu_med, 
           Predicted = cfu_all_rf$predicted) %>% 
  ggplot(aes(x = Predicted, y = Observed)) + geom_point() +
    xlim(5,9) + ylim(5,9) + 
    annotate('text', label = paste0(round(tail(cfu_all_rf$rsq, 1), 4)*100, '% Var Explained'),
             x = min(cfu_all_rf$predicted), y = max(cfu_all_shared_df$log_cfu_med)) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) +
  labs(x = 'Predicted Colonization (log CFU)', y = 'Observed Colonization (log CFU)')
    

```

```{r colonization performance, fig.width=8, fig.height=6}
top_otus <- get_tax(row_list = names(top_features))$tax_label
```

```{r colonization otu importance, fig.width=6, fig.height=6}
data.frame(OTU = factor(top_otus, 
                        levels = top_otus[order(top_features)]), 
           Importance = top_features/max(top_features)) %>% 
  ggplot(aes(x = OTU, y = Importance)) + 
    geom_point() + coord_flip() + 
    labs(y = 'Importance (Relative MDA)', x = NULL) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_line(colour = "gray", linetype = "dotted"),
          panel.grid.minor.y = element_line(colour = "gray", linetype = "dotted"),
          axis.text.y = element_text(color = c(rep('black', length(top_features)-12),
                                               rep('red', 12)), 
                                     hjust = 0))
```

```{r plot colonization otu correlations, fig.width=10, fig.height=8}
top_n_otus <- get_tax(row_list = names(head(top_features,12)))
top_n_otus$cor_label <- paste0(top_n_otus$tax, '(OTU',
                           gsub('Otu0*', '', rownames(top_n_otus)),
                           ';rho= ', round(feat_cor_cfu[names(feat_cor_cfu) 
                                                       %in% rownames(top_n_otus)], 
                                          2), ')')
top_n_otus$cor_label <- factor(top_n_otus$cor_label,
                               levels = top_n_otus$cor_label[order(head(top_features,12),
                                                                   decreasing = T)])
top_n_otus$OTU <- rownames(top_n_otus)
subset(cfu_all_shared_df, select = 
       c("log_cfu_med", rownames(top_n_otus))) %>% 
  gather(OTU, abundance, contains('Otu')) %>%
  left_join(top_n_otus) %>% 
  mutate(abundance = abundance + 0.01) %>% 
  ggplot(aes(x = abundance, y = log_cfu_med)) + geom_point() + 
    facet_wrap(~cor_label, ncol = 4, scales = 'free_x') +  
    labs(x= 'Relative Abundance - Day 0 (log %)', y = 'Observed Colonization (log CFU)') + 
    ylim(5, 9) + scale_x_log10(breaks = c(0.01, 0.1, 1, 10, 100),
                               labels = c(0, 0.1, 1, 10, 100)) +
    geom_vline(xintercept = 0.06, color = 'gray') + 
    theme(strip.background = element_rect(colour=NULL, fill='white'),
          panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.x = #element_line(linetype = 1, size = .1, color = 'gray'),
                               element_blank(),    
          panel.grid.minor.x = element_blank())
```

***

```{r predict inocula, fig.width=10,fig.height=10}
source_all_shared_df <- colonized_cfu %>% 
    select(mouse_id, human_source) %>% 
    right_join(community_all_d0) %>% 
    select(-mouse_id)
source_all_shared_df$human_source <- as.factor(source_all_shared_df$human_source)

#output <- data.frame(ntree = NA, ntry = NA, err = NA)
#for(tree in seq(1, 1500, 100)){
#  for(try in 1:30){
#    set.seed(seed)
#    source_all_rf <- randomForest(source_all_shared_df[ , -1], source_all_shared_df$human_source,
#                           ntree = tree,
#                           mtry = try,
#                           importance = T)
#    output <- rbind(output, c(tree, try, tail(source_all_rf$err.rate[,'OOB'], 1)))
#  }
#}
#
#ggplot(output, aes(x=ntry, y=err, group = ntree, color = as.factor(ntree))) + geom_line()
#ggplot(output[output$ntry == 15,], aes(x=ntree, y=err)) + geom_line()

set.seed(seed)
source_all_rf <- randomForest(source_all_shared_df[ , -1], source_all_shared_df$human_source,
                           ntree = 501,
                           mtry = 15,
                           importance = T)
top_features_src <- head(sort(importance(source_all_rf)[,1],decreasing = T), n_features)
#any(names(top_features) %in% names(top_features_src))
src_feat_cor_cfu <- cor(cfu_all_shared_df[ , c('log_cfu_med', 
                                               names(top_features_src))], 
                        method = 'spearman')[-1,'log_cfu_med']
```

##### OTUs predictive of _Inocula Source_ (Top 10%)  
Model built using all OTUs present in >10% of samples, only displaying top 10% of predictive features

```{r source otu importance, fig.width=6, fig.height=6}
confusionMatrix(source_all_rf$predicted, source_all_shared_df$human_source)$table

top_otus_src <- get_tax(row_list = names(top_features_src))$tax_label

data.frame(OTU = factor(top_otus_src, 
                        levels = top_otus_src[order(top_features_src)]), 
           Importance = top_features_src/max(top_features_src)) %>% 
  ggplot(aes(x = OTU, y = Importance)) + 
    geom_point() + coord_flip() + 
    labs(y = 'Importance (Relative MDA)', x = NULL) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_line(colour = "gray", linetype = "dotted"),
          panel.grid.minor.y = element_line(colour = "gray", linetype = "dotted"),
          axis.text.y = element_text(color = c(rep('black', length(top_features)-12),
                                               rep('red', 12)), 
                                     hjust = 0))
```


```{r plot source otu correlations, fig.width=10, fig.height=8}
top_n_otus_src <- get_tax(row_list = names(head(top_features_src,12)))
top_n_otus_src$cor_label <- paste0(top_n_otus_src$tax, '(OTU',
                           gsub('Otu0*', '', rownames(top_n_otus_src)),
                           ';rho= ', round(src_feat_cor_cfu[names(src_feat_cor_cfu) 
                                                       %in% rownames(top_n_otus_src)], 
                                          2), ')')
top_n_otus_src$OTU <- rownames(top_n_otus_src)
top_n_otus_src$cor_label <- factor(top_n_otus_src$cor_label,
                               levels = top_n_otus_src$cor_label[order(head(top_features_src,12),
                                                                   decreasing = T)])

subset(cfu_all_shared_df, select = 
       c("log_cfu_med", rownames(top_n_otus_src))) %>% 
  gather(OTU, abundance, contains('Otu')) %>%
  left_join(top_n_otus_src) %>%
  mutate(abundance = abundance + 0.01) %>% 
  ggplot(aes(x = abundance, y = log_cfu_med)) + 
    geom_vline(xintercept = 0.06, color = 'gray') + geom_point() + 
    facet_wrap(~cor_label, ncol = 4, scales = 'free_x') +  
    labs(x= 'Relative Abundance - Day 0 (log %)', y = 'Observed Colonization (log CFU)') + 
    ylim(5, 9) + scale_x_log10(breaks = c(0.01, 0.1, 1, 10, 100),
                               labels = c(0, 0.1, 1, 10, 100)) +
    theme(strip.background = element_rect(colour=NULL, fill='white'),
          panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.x = #element_line(linetype = 1, size = .1, color = 'gray'),
                               element_blank(),    
          panel.grid.minor.x = element_blank())
```

***  


There are `r sum(names(top_features) %in% names(top_features_src))` OTUs that overlap between predicting Colonization and Source:  
`r names(top_features)[names(top_features) %in% names(top_features_src)]`

***

##### OTUs predictive of _Colonization level_ with Source included (Top 10%)  
Model built using all OTUs present in >10% of samples, only displaying top 10% of predictive features

```{r predict median CFU with source, fig.width=10,fig.height=10}
cfu_all_src_shared_df <- colonized_cfu %>% 
    select(mouse_id, log_cfu_med, human_source) %>% 
    right_join(community_all_d0) %>% 
    select(-mouse_id) %>% 
    filter(!is.na(log_cfu_med))
cfu_all_src_shared_df$human_source <- factor(cfu_all_src_shared_df$human_source)
#output <- data.frame(ntree = NA, ntry = NA, rsq = NA)
#for(tree in seq(1, 1500, 100)){
#  for(try in 1:30){
#    set.seed(seed)
#    cfu_all_rf <- randomForest(cfu_all_shared_df[ , -1], cfu_all_shared_df$log_cfu_med,
#                           ntree = tree,
#                           mtry = try,
#                           importance = T)
#    output <- rbind(output, c(tree, try, tail(cfu_all_rf$rsq, 1)))
#  }
#}
#
#ggplot(output[output$ntree !=1,], aes(x=ntree, y=rsq, group = ntry, color = as.factor(ntry))) + geom_line()
#ggplot(output[output$ntree == 1001,], aes(x=ntry, y=rsq)) + geom_line()

set.seed(seed)
cfu_all_src_rf <- randomForest(cfu_all_src_shared_df[ , -1], cfu_all_src_shared_df$log_cfu_med,
                           ntree = 1001,
                           mtry = 15,
                           importance = T)
top_features_src_cfu <- head(sort(importance(cfu_all_src_rf)[,1],decreasing = T), n_features)
feature_df_src_numeric <- cfu_all_src_shared_df[ , c('log_cfu_med', names(top_features_src_cfu))]
feature_df_src_numeric$human_source <- as.numeric(feature_df_src_numeric$human_source)
feat_cor_cfu_src_all <- cor(feature_df_src_numeric, method = 'spearman')[-1,'log_cfu_med']
```


```{r prediction cfu plot with source, fig.width=6, fig.height=6}

data.frame(Observed = cfu_all_src_shared_df$log_cfu_med, 
           Predicted = cfu_all_src_rf$predicted) %>% 
  ggplot(aes(x = Predicted, y = Observed)) + geom_point() +
    xlim(5,9) + ylim(5,9) + 
    annotate('text', label = paste0(round(tail(cfu_all_src_rf$rsq, 1), 4)*100, '% Var Explained'),
             x = min(cfu_all_src_rf$predicted), y = max(cfu_all_src_shared_df$log_cfu_med)) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) +
  labs(x = 'Predicted Colonization (log CFU)', y = 'Observed Colonization (log CFU)')
    

```

```{r colonization performance with source, fig.width=8, fig.height=6}
top_otus_all_src <- get_tax(row_list = names(top_features_src_cfu)[-1])$tax_label
top_otus_all_src <- c('Human Source', top_otus_all_src)
```

```{r colonization otu importance with source, fig.width=6, fig.height=6}
data.frame(OTU = factor(top_otus_all_src, 
                        levels = top_otus_all_src[order(top_features_src_cfu)]), 
           Importance = top_features_src_cfu/max(top_features_src_cfu)) %>% 
  ggplot(aes(x = OTU, y = Importance)) + 
    geom_point() + coord_flip() + 
    labs(y = 'Importance (Relative MDA)', x = NULL) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          axis.ticks = element_line(size = 2),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_line(colour = "gray", linetype = "dotted"),
          panel.grid.minor.y = element_line(colour = "gray", linetype = "dotted"),
          axis.text.y = element_text(color = c(rep('black', length(top_features_src_cfu)-12),
                                               rep('red', 12)), 
                                     hjust = 0))
```

```{r plot colonization otu correlations with source, fig.width=10, fig.height=8}
top_n_otus_all_src <- get_tax(row_list = names(head(top_features_src_cfu[-1],12)))
top_n_otus_all_src$cor_label <- paste0(top_n_otus_all_src$tax, '(OTU',
                           gsub('Otu0*', '', rownames(top_n_otus_all_src)),
                           ';rho= ', round(feat_cor_cfu_src_all[names(feat_cor_cfu_src_all) 
                                                       %in% rownames(top_n_otus_all_src)], 
                                          2), ')')
top_n_otus_all_src$cor_label <- factor(top_n_otus_all_src$cor_label,
                               levels = top_n_otus_all_src$cor_label[order(head(top_features,12),
                                                                   decreasing = T)])
top_n_otus_all_src$OTU <- rownames(top_n_otus_all_src)
subset(feature_df_src_numeric, select = 
       c("log_cfu_med", rownames(top_n_otus_all_src))) %>% 
  gather(OTU, abundance, -log_cfu_med) %>%
  left_join(top_n_otus_all_src) %>% 
  mutate(abundance = abundance + 0.01) %>% 
  ggplot(aes(x = abundance, y = log_cfu_med)) + 
    geom_vline(xintercept = 0.06, color = 'gray') + geom_point() + 
    facet_wrap(~cor_label, ncol = 4, scales = 'free_x') +  
    labs(x= 'Relative Abundance - Day 0 (log %)', y = 'Observed Colonization (log CFU)') + 
    ylim(5, 9) + scale_x_log10(breaks = c(0.01, 0.1, 1, 10, 100),
                               labels = c(0, 0.1, 1, 10, 100)) +
    theme(strip.background = element_rect(colour=NULL, fill='white'),
          panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.x = #element_line(linetype = 1, size = .1, color = 'gray'),
                               element_blank(),    
          panel.grid.minor.x = element_blank())
```

***

#### OTUs predictive of CFU (One Mouse)