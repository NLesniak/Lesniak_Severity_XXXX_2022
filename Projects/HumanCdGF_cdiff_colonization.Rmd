---
title: "Model_CFU"
author: "Nicholas Lesniak"
date: "December 5, 2016"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, fig.width=7, fig.height=8)
```

```{r setup environment}
pack_used <- c('randomForest','tidyr','ggplot2','plyr', 'dplyr', 'caret')
for (dep in pack_used){
  if (dep %in% installed.packages()[,"Package"] == FALSE){
    install.packages(as.character(dep), repos = 'http://cran.us.r-project.org', 
                     quiet=TRUE);
  }
  library(dep, verbose=FALSE, character.only=TRUE)
}
```

```{r setup data}
# read in files
setwd('~/Documents/Github/Schubert_humanCdGF_XXXX_2016/')
meta_data   <- 'data/process/human_CdGF_metadata.txt'
shared_file <- 'data/process/human_CdGF.an.unique_list.0.03.subsample.shared'
tax_file <- 'data/process/gf_new.an.taxonomy'
tax_function <- 'code/tax_level.R'

# read in files
meta_data   <- read.table(meta_data, sep = '\t', header = T, stringsAsFactors = F)
shared_file <- read.table(shared_file, sep = '\t', header = T, row.names = 'sample_id')
tax_file <- read.table(tax_file, sep = '\t', header = T, row.names = 'OTU')
source(tax_function)

# set parameters
seed <- 1
#n_trees <- 1001
#n_otus <- 12
iters <- 100
#cor_cutoff <- 0.75
otu_presence_cutoff <- 0.1

# remove samples not used or with other cdiff strains
meta_data <- 
  meta_data %>% 
  filter(Early_Euth == FALSE, cdiff_strain == 431, !cage_id == 'NP1') %>% 
  select(mouse_id, sample_id, cage_id, human_source, day, log_cfu) %>% 
  filter(!is.na(log_cfu))
shared_list_days <- meta_data %>% 
  filter(day == 0) %>% 
  select(-day, -log_cfu, -cage_id, -human_source)
shared_file <- shared_file[rownames(shared_file) %in% shared_list_days$sample_id, ]

# create shared with relative abundances over 1%
mean_otu_counts <- unique(apply(shared_file, 1, sum))
otu_presence <- ifelse(shared_file > 0, T, F) 
rel_abund_shared <- shared_file[ , apply(otu_presence, 2, sum) > round(otu_presence_cutoff*nrow(shared_file))]
rel_abund_shared_01 <- 100*rel_abund_shared/mean_otu_counts

n_features <- round(0.1*ncol(rel_abund_shared))

## remove correlative otus
#rel_abund_cor <- cor(rel_abund_shared_01, method = 'spearman')
#rownames(rel_abund_cor) <- colnames(rel_abund_shared_01) # add row names to identify otus correlated with features
#cor_otus <- findCorrelation(rel_abund_cor, cutoff = cor_cutoff)
#rel_abund_01_filtr <- rel_abund_shared_01[,-cor_otus]
#community_d0.df <- merge(shared_list_days, rel_abund_01_filtr, 
#                         by.x = 'sample_id', by.y = 'row.names') %>% 
#                    select(-sample_id)

colonized_cfu <- meta_data %>% 
  filter(day %in% c(4:10)) %>% 
  group_by(mouse_id, cage_id, human_source) %>% 
  summarise(log_cfu_med = median(log_cfu)) %>% 
  ungroup()

community_all_d0 <- merge(shared_list_days, rel_abund_shared_01, 
                          by.x = 'sample_id', by.y = 'row.names') %>% 
                     select(-sample_id)
```

### Predicting __Colonization Level__ (Log10 CFU) with Day 0 Community

```{r predict median CFU, fig.width=10,fig.height=10}
cfu_all_shared_df <- colonized_cfu %>% 
    select(mouse_id, log_cfu_med) %>% 
    right_join(community_all_d0) %>% 
    select(-mouse_id) %>% 
    filter(!is.na(log_cfu_med))

#output <- data.frame(ntree = NA, ntry = NA, rsq = NA)
#for(tree in seq(1, 1500, 100)){
#  for(try in 1:30){
#    set.seed(seed)
#    cfu_all_rf <- randomForest(cfu_all_shared_df[ , -1], cfu_all_shared_df$log_cfu_med,
#                           ntree = tree,
#                           mtry = try,
#                           importance = T)
#    output <- rbind(output, c(tree, try, tail(cfu_all_rf$rsq, 1)))
#  }
#}
#
#ggplot(output[output$ntree !=1,], aes(x=ntree, y=rsq, group = ntry, color = as.factor(ntry))) + geom_line()
#ggplot(output[output$ntree == 1001,], aes(x=ntry, y=rsq)) + geom_line()

set.seed(seed)
cfu_all_rf <- randomForest(cfu_all_shared_df[ , -1], cfu_all_shared_df$log_cfu_med,
                           ntree = 1001,
                           mtry = 15,
                           importance = T)
top_features <- head(sort(importance(cfu_all_rf)[,1],decreasing = T), n_features)
feat_cor_cfu <- cor(cfu_all_shared_df[ , c('log_cfu_med', 
                                           names(top_features))],
                    method = 'spearman')[-1,'log_cfu_med']
```

##### Modeling _Colonization level_ (Top 10%)  
Model built using all OTUs present in >10% of samples, only displaying top 10% of predictive features

```{r prediction cfu plot, fig.width=6, fig.height=6}

data.frame(Observed = cfu_all_shared_df$log_cfu_med, 
           Predicted = cfu_all_rf$predicted) %>% 
  ggplot(aes(x = Predicted, y = Observed)) + geom_point() +
    xlim(5,9) + ylim(5,9) + 
    annotate('text', label = paste0(round(tail(cfu_all_rf$rsq, 1), 4)*100, '% Var Explained'),
             x = min(cfu_all_rf$predicted), y = max(cfu_all_shared_df$log_cfu_med)) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) +
  labs(x = 'Predicted Colonization (log CFU)', y = 'Observed Colonization (log CFU)')
    

```

```{r colonization performance, fig.width=8, fig.height=6}
top_otus <- get_tax(row_list = names(top_features))$tax_label
```


##### OTUs predictive of __Colonization level__ (Top 10%)  
Red OTUs are top 12 which are plotted against CFU below

```{r colonization otu importance, fig.width=6, fig.height=6}
data.frame(OTU = factor(top_otus, 
                        levels = top_otus[order(top_features)]), 
           Importance = top_features/max(top_features)) %>% 
  ggplot(aes(x = OTU, y = Importance)) + 
    geom_point() + coord_flip() + 
    labs(y = 'Importance (Relative MDA)', x = NULL) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_line(colour = "gray", linetype = "dotted"),
          panel.grid.minor.y = element_line(colour = "gray", linetype = "dotted"),
          axis.text.y = element_text(color = c(rep('black', length(top_features)-12),
                                               rep('red', 12)), 
                                     hjust = 0))
```

##### Correlation of OTU and CFU (top 12 OTUs predictive of __Colonization level__)  
Points colored by human donor

```{r plot colonization otu correlations, fig.width=10, fig.height=8}
top_n_otus <- get_tax(row_list = names(head(top_features,12)))
top_n_otus$cor_label <- paste0(top_n_otus$tax, '(OTU',
                           gsub('Otu0*', '', rownames(top_n_otus)),
                           ';rho= ', round(feat_cor_cfu[names(feat_cor_cfu) 
                                                       %in% rownames(top_n_otus)], 
                                          2), ')')
top_n_otus$cor_label <- factor(top_n_otus$cor_label,
                               levels = top_n_otus$cor_label[order(head(top_features,12),
                                                                   decreasing = T)])
top_n_otus$OTU <- rownames(top_n_otus)
subset(cfu_all_shared_df, select = 
       c("log_cfu_med", rownames(top_n_otus))) %>% 
  left_join(colonized_cfu[ , c('log_cfu_med', 'human_source')]) %>% 
  gather(OTU, abundance, contains('Otu')) %>%
  left_join(top_n_otus) %>% 
  mutate(abundance = abundance + 0.01) %>% 
  ggplot(aes(x = abundance, y = log_cfu_med, color = human_source)) + geom_point() + 
    facet_wrap(~cor_label, ncol = 4, scales = 'free_x') +  
    labs(x= 'Relative Abundance - Day 0 (log %)', y = 'Observed Colonization (log CFU)') + 
    ylim(5, 9) + scale_x_log10(breaks = c(0.01, 0.1, 1, 10, 100),
                               labels = c(0, 0.1, 1, 10, 100)) +
    geom_vline(xintercept = 0.06, color = 'gray') + 
    theme(strip.background = element_rect(colour=NULL, fill='white'),
          panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.x = #element_line(linetype = 1, size = .1, color = 'gray'),
                               element_blank(),    
          panel.grid.minor.x = element_blank(),
          legend.position="none")
```

Are these OTUs identifying susceptiblility to _C. Difficile_ of only correlated to _C. difficile_ due to OTUs unique to the donor, i.e. is the OTU predicting the cage grouping?

***  

### Predicting __Human Donor__ with Day 0 Community  
Is there overlap in OTUs predictive of CFU and Donor?


```{r predict inocula, fig.width=10,fig.height=10}
source_all_shared_df <- colonized_cfu %>% 
    select(mouse_id, human_source) %>% 
    right_join(community_all_d0) %>% 
    select(-mouse_id)
source_all_shared_df$human_source <- as.factor(source_all_shared_df$human_source)

#output <- data.frame(ntree = NA, ntry = NA, err = NA)
#for(tree in seq(1, 1500, 100)){
#  for(try in 1:30){
#    set.seed(seed)
#    source_all_rf <- randomForest(source_all_shared_df[ , -1], source_all_shared_df$human_source,
#                           ntree = tree,
#                           mtry = try,
#                           importance = T)
#    output <- rbind(output, c(tree, try, tail(source_all_rf$err.rate[,'OOB'], 1)))
#  }
#}
#
#ggplot(output, aes(x=ntry, y=err, group = ntree, color = as.factor(ntree))) + geom_line()
#ggplot(output[output$ntry == 15,], aes(x=ntree, y=err)) + geom_line()

set.seed(seed)
source_all_rf <- randomForest(source_all_shared_df[ , -1], source_all_shared_df$human_source,
                           ntree = 501,
                           mtry = 15,
                           importance = T)
top_features_src <- head(sort(importance(source_all_rf)[,1],decreasing = T), n_features)
#any(names(top_features) %in% names(top_features_src))
src_feat_cor_cfu <- cor(cfu_all_shared_df[ , c('log_cfu_med', 
                                               names(top_features_src))], 
                        method = 'spearman')[-1,'log_cfu_med']
```

##### Modeling of __Human Donor__ (Top 10%)  
Model built using all OTUs present in >10% of samples, only displaying top 10% of predictive features  

```{r source model, fig.width=6, fig.height=6}
confusionMatrix(source_all_rf$predicted, source_all_shared_df$human_source)$table
```

##### OTUs predictive of __Human Donor__ (Top 10%)  
Red OTUs are top 12 which are plotted against CFU below  

```{r source otu importance, fig.width=6, fig.height=6}
top_otus_src <- get_tax(row_list = names(top_features_src))$tax_label

data.frame(OTU = factor(top_otus_src, 
                        levels = top_otus_src[order(top_features_src)]), 
           Importance = top_features_src/max(top_features_src)) %>% 
  ggplot(aes(x = OTU, y = Importance)) + 
    geom_point() + coord_flip() + 
    labs(y = 'Importance (Relative MDA)', x = NULL) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_line(colour = "gray", linetype = "dotted"),
          panel.grid.minor.y = element_line(colour = "gray", linetype = "dotted"),
          axis.text.y = element_text(color = c(rep('black', length(top_features)-12),
                                               rep('red', 12)), 
                                     hjust = 0))
```

##### Correlation of OTU and CFU (top 12 OTUs predictive of __Human Donor__)  
Points colored by human donor

```{r plot source otu correlations, fig.width=10, fig.height=8}
top_n_otus_src <- get_tax(row_list = names(head(top_features_src,12)))
top_n_otus_src$cor_label <- paste0(top_n_otus_src$tax, '(OTU',
                           gsub('Otu0*', '', rownames(top_n_otus_src)),
                           ';rho= ', round(src_feat_cor_cfu[names(src_feat_cor_cfu) 
                                                       %in% rownames(top_n_otus_src)], 
                                          2), ')')
top_n_otus_src$OTU <- rownames(top_n_otus_src)
top_n_otus_src$cor_label <- factor(top_n_otus_src$cor_label,
                               levels = top_n_otus_src$cor_label[order(head(top_features_src,12),
                                                                   decreasing = T)])

subset(cfu_all_shared_df, select = 
       c("log_cfu_med", rownames(top_n_otus_src))) %>% 
  left_join(colonized_cfu[ , c('log_cfu_med', 'human_source')]) %>% 
  gather(OTU, abundance, contains('Otu')) %>%
  left_join(top_n_otus_src) %>%
  mutate(abundance = abundance + 0.01) %>% 
  ggplot(aes(x = abundance, y = log_cfu_med, color = human_source)) + 
    geom_vline(xintercept = 0.06, color = 'gray') + geom_point() + 
    facet_wrap(~cor_label, ncol = 4, scales = 'free_x') +  
    labs(x= 'Relative Abundance - Day 0 (log %)', y = 'Observed Colonization (log CFU)') + 
    ylim(5, 9) + scale_x_log10(breaks = c(0.01, 0.1, 1, 10, 100),
                               labels = c(0, 0.1, 1, 10, 100)) +
    theme(strip.background = element_rect(colour=NULL, fill='white'),
          panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.x = #element_line(linetype = 1, size = .1, color = 'gray'),
                               element_blank(),    
          panel.grid.minor.x = element_blank(),
          legend.position='none')
```


There are `r sum(names(top_features) %in% names(top_features_src))` OTUs that overlap between predicting Colonization and Source:  
`r names(top_features)[names(top_features) %in% names(top_features_src)]`  
It is possible these OTUs are selected in predicting __Colonization__ because they are helping to seperate the groups of mice by cage. It is interesting though that the OTU 4 and OTU 14 were previously identified as being correlated (rho = 0.7586887) but only OTU 14 is predictive of Donor. Otu000004 is in the top `r print(paste0(round(which(names(sort(importance(source_all_rf)[,1],decreasing = T)) == 'Otu000004')/length(importance(source_all_rf)[,1]), 2)*100, '%'))` of OTUs predictive of Human Donor with a relative MDA of `r importance(source_all_rf)['Otu000004',1]/max(importance(source_all_rf)[,1])`.  
```{r plot otu correlations_entero, fig.width=3,fig.height=3}
ggplot(cfu_all_shared_df, aes(x=Otu000004, y=Otu000014))+geom_point(alpha = 0.5)
```

As for OTU 283 and 5, those are correlated (rho = 0.8235480) and they are also correlated to Otu000171 (0.7891608), Otu000196 (0.8190665), Otu000202 (0.8147822), Otu000255 (0.8230815), Otu000262 (0.8141814), Otu000283 (0.8268792), Otu000394 (0.8321597), Otu000403 (0.8258554), which are all in the top 10% of OTUs predictive of __Colonization__.
```{r plot otu correlations, fig.width=9,fig.height=9}
cfu_all_shared_df %>% 
  select(Otu000005, Otu000171, Otu000196, Otu000202, Otu000255, Otu000262, 
         Otu000283, Otu000394, Otu000403) %>% 
  gather(OTU, Abundance, -Otu000283) %>% 
  ggplot(aes(x=Otu000283, y=Abundance))+geom_point(alpha = 0.5) + facet_wrap(~OTU, nrow =3, scales = 'free_y')
```

Do correlated OTUs matter?


***

##### Model __Colonization level__ with Human Donor included
Model built using all OTUs present in >10% of samples, only displaying top 10% of predictive features

```{r predict median CFU with source, fig.width=10,fig.height=10}
cfu_all_src_shared_df <- colonized_cfu %>% 
    select(mouse_id, log_cfu_med, human_source) %>% 
    right_join(community_all_d0) %>% 
    select(-mouse_id) %>% 
    filter(!is.na(log_cfu_med))
cfu_all_src_shared_df$human_source <- factor(cfu_all_src_shared_df$human_source)
#output <- data.frame(ntree = NA, ntry = NA, rsq = NA)
#for(tree in seq(1, 1500, 100)){
#  for(try in 1:30){
#    set.seed(seed)
#    cfu_all_rf <- randomForest(cfu_all_shared_df[ , -1], cfu_all_shared_df$log_cfu_med,
#                           ntree = tree,
#                           mtry = try,
#                           importance = T)
#    output <- rbind(output, c(tree, try, tail(cfu_all_rf$rsq, 1)))
#  }
#}
#
#ggplot(output[output$ntree !=1,], aes(x=ntree, y=rsq, group = ntry, color = as.factor(ntry))) + geom_line()
#ggplot(output[output$ntree == 1001,], aes(x=ntry, y=rsq)) + geom_line()

set.seed(seed)
cfu_all_src_rf <- randomForest(cfu_all_src_shared_df[ , -1], cfu_all_src_shared_df$log_cfu_med,
                           ntree = 1001,
                           mtry = 15,
                           importance = T)
top_features_src_cfu <- head(sort(importance(cfu_all_src_rf)[,1],decreasing = T), n_features)
feature_df_src_numeric <- cfu_all_src_shared_df[ , c('log_cfu_med', names(top_features_src_cfu))]
feature_df_src_numeric$human_source <- as.numeric(feature_df_src_numeric$human_source)
feat_cor_cfu_src_all <- cor(feature_df_src_numeric, method = 'spearman')[-1,'log_cfu_med']
```


```{r prediction cfu plot with source, fig.width=6, fig.height=6}

data.frame(Observed = cfu_all_src_shared_df$log_cfu_med, 
           Predicted = cfu_all_src_rf$predicted) %>% 
  ggplot(aes(x = Predicted, y = Observed)) + geom_point() +
    xlim(5,9) + ylim(5,9) + 
    annotate('text', label = paste0(round(tail(cfu_all_src_rf$rsq, 1), 4)*100, '% Var Explained'),
             x = min(cfu_all_src_rf$predicted), y = max(cfu_all_src_shared_df$log_cfu_med)) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) +
  labs(x = 'Predicted Colonization (log CFU)', y = 'Observed Colonization (log CFU)')
    

```

##### OTUs predictive of _Colonization level_ with Source included (Top 10%)  
Top 12 OTUs in red are plotted against CFU below

```{r colonization performance with source, fig.width=8, fig.height=6}
top_otus_all_src <- get_tax(row_list = names(top_features_src_cfu)[-1])$tax_label
top_otus_all_src <- c('Human Source', top_otus_all_src)
```

```{r colonization otu importance with source, fig.width=6, fig.height=6}
data.frame(OTU = factor(top_otus_all_src, 
                        levels = top_otus_all_src[order(top_features_src_cfu)]), 
           Importance = top_features_src_cfu/max(top_features_src_cfu)) %>% 
  ggplot(aes(x = OTU, y = Importance)) + 
    geom_point() + coord_flip() + 
    labs(y = 'Importance (Relative MDA)', x = NULL) + 
    theme(panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          axis.ticks = element_line(size = 2),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_line(colour = "gray", linetype = "dotted"),
          panel.grid.minor.y = element_line(colour = "gray", linetype = "dotted"),
          axis.text.y = element_text(color = c(rep('black', length(top_features_src_cfu)-13),
                                               rep('red', 12), 'black'), 
                                     hjust = 0))
```

```{r plot colonization otu correlations with source, fig.width=10, fig.height=8}
top_n_otus_all_src <- get_tax(row_list = names(head(top_features_src_cfu[-1],12)))
top_n_otus_all_src$cor_label <- paste0(top_n_otus_all_src$tax, '(OTU',
                           gsub('Otu0*', '', rownames(top_n_otus_all_src)),
                           ';rho= ', round(feat_cor_cfu_src_all[names(feat_cor_cfu_src_all) 
                                                       %in% rownames(top_n_otus_all_src)], 
                                          2), ')')
top_n_otus_all_src$cor_label <- factor(top_n_otus_all_src$cor_label,
                               levels = top_n_otus_all_src$cor_label[order(head(top_features,12),
                                                                   decreasing = T)])
top_n_otus_all_src$OTU <- rownames(top_n_otus_all_src)
subset(feature_df_src_numeric, select = 
       c("log_cfu_med", rownames(top_n_otus_all_src))) %>% 
  gather(OTU, abundance, -log_cfu_med) %>%
  left_join(top_n_otus_all_src) %>% 
  mutate(abundance = abundance + 0.01) %>% 
  ggplot(aes(x = abundance, y = log_cfu_med)) + 
    geom_vline(xintercept = 0.06, color = 'gray') + geom_point() + 
    facet_wrap(~cor_label, ncol = 4, scales = 'free_x') +  
    labs(x= 'Relative Abundance - Day 0 (log %)', y = 'Observed Colonization (log CFU)') + 
    ylim(5, 9) + scale_x_log10(breaks = c(0.01, 0.1, 1, 10, 100),
                               labels = c(0, 0.1, 1, 10, 100)) +
    theme(strip.background = element_rect(colour=NULL, fill='white'),
          panel.background = element_rect(linetype = 1, size = 1, fill = 'white', color = 'black'),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.x = #element_line(linetype = 1, size = .1, color = 'gray'),
                               element_blank(),    
          panel.grid.minor.x = element_blank())
```


There are `r sum(names(top_features) %in% names(top_features_src_cfu))` OTUs that overlap between predicting Colonization and Source:  
`r names(top_features)[names(top_features) %in% names(top_features_src_cfu)]`  
Including Human Source includes all the OTUs predictive of __Colonization__ as well as Human Source as the top predictor. Relative importances of some OTUs are shifted, which could be due to the randomness of the RF algorithm or due to the effect of adding Human source, which may imply part of their predictive power is attributed to the human donor dependency. OTU 357 is added, however it is just below the 10% cutoff for the model without human source. Thus there appears to be no significant difference in predictive OTUs in the presence/absence of human donor data.  

There are `r sum(names(top_features_src) %in% names(top_features_src_cfu))` OTUs that overlap between predicting Colonization and Source:  
`r names(top_features_src)[names(top_features_src) %in% names(top_features_src_cfu)]`  
Comparing the OTUs predictive of __Colonization__ when including human source is similarlly different from the OTUs predictive of __Human Donor__. The same OTUs are shared, which is not suprising since both models predicting __Colonization__ use the same OTUs. Aside from those shared and even the correlated OTUs we still have a much different set of predictors, which seems to potentially reveal the ability of the microbiome to predict community members associated with _C. difficile_ colonization.

***

#### Modeling CFU with One Mouse per Human Donor
In an effort to remove any potential donor community dependency, the model is trained on a single mouse per human donor source, and then tested on all the remaining mice

##### With all OTUs
```{r one mouse model}

#One per source
one_mouse_df <- data.frame(colonized_cfu %>% 
    right_join(community_all_d0) %>% 
    filter(!is.na(log_cfu_med)))
one_mouse_df$human_source <- factor(one_mouse_df$human_source)

om_import_otus <- data.frame(otu = colnames(select(one_mouse_df, -mouse_id, -cage_id, -log_cfu_med)))
om_pred <- c()
om_rsq <- c()
for(i in 1:iters){
    set.seed(i)
    train <- one_mouse_df %>% 
      group_by(human_source) %>% 
      sample_n(1) %>% ungroup() 
    test <- one_mouse_df %>% 
      filter(!mouse_id %in% train$mouse_id)
    set.seed(seed)
    rf_om <- randomForest(log_cfu_med ~ ., data = select(train, -mouse_id, -cage_id),
                             importance = TRUE, keep.forest = T, ntree = n_trees)
    om_pred <- rbind(om_pred,
                     data.frame(select(test, mouse_id, cage_id, log_cfu_med),
                          predicted=predict(rf_om, test),
                          iter = i))
    om_rsq <- rbind(om_rsq, c(iter = i,
                              mice = paste(train$mouse_id, collapse = ' '), 
                              train_rsq = tail(rf_om$rsq,1),
                              test_rsq = 1 - (sum((test$log_cfu_med - predict(rf_om, test))^2)/
                                sum((test$log_cfu_med - mean(test$log_cfu_med))^2))))
    import_df <- importance(rf_om)
    colnames(import_df)[1] <- paste(train$mouse_id, collapse = ' ')
    om_import_otus <- merge(om_import_otus, import_df, by.x = 'otu', by.y = 'row.names') %>% 
      select(-IncNodePurity)
}
om_rsq <- data.frame(iter = as.numeric(om_rsq[,1]),
           mice = om_rsq[,2],
           train_rsq = as.numeric(om_rsq[,3]),
           test_rsq = as.numeric(om_rsq[,4]),
           stringsAsFactors = F)
om_rsq_overall <- 1 - (sum((om_pred$log_cfu_med - om_pred$predicted)^2)/
               sum((om_pred$log_cfu_med - mean(om_pred$log_cfu_med))^2))

om_pred <- rename(om_pred, observed = log_cfu_med)

all_otus_importance <- gather(om_import_otus,OTU, import_val,-otu)[,-2]
all_otus_importance$votes <- ifelse(all_otus_importance$import_val > 0, 1, 0)
all_otus_importance <- data.frame(table(all_otus_importance[,-2]))
pos_otu <- all_otus_importance[(filter(all_otus_importance, votes == 1) %>% select(Freq) - 
                      filter(all_otus_importance, votes == 0) %>% select(Freq)) > 0, ]
pos_otu <- data.frame(predictor = pos_otu$otu[pos_otu$votes==1],
                      filter(pos_otu, votes == 1) %>% select(Freq) - 
                      filter(pos_otu, votes == 0) %>% select(Freq)) %>% 
              arrange(desc(Freq))
```

When using all OTUs the model preforms poorly. The median Rsq of the trainset was `r median(om_rsq$train_rsq)`, this is likely do to the features. This is a summary of the importance scores for all predictors:  
`r summary(unlist(select(om_import_otus, -otu)))`  
`r round(100*sum(om_import_otus[,-1]<=0, na.rm = T)/length(om_import_otus[,-1]<=0),2)`% of OTUs have an importance of 0 or less. The median Rsq of the test set was `r median(om_rsq$test_rsq)` and the Rsq of all predicted values was `r om_rsq_overall`.  

This one mouse per source model is improved through reducing the amount of negative features, either utilizing the feature set via the top X % of predictors from the model of all mice or take only the features that are more often have an importance > 0 (OTUs : `r as.character(pos_otu$predictor)`).

```{r one mouse model - with OTUs positive in All OTU one mouse model}

#One per source - > 0
one_mouse_pos_otus_df <- data.frame(colonized_cfu %>% 
    right_join(community_all_d0) %>% 
    filter(!is.na(log_cfu_med))) %>% 
    select(mouse_id, human_source, log_cfu_med,
           one_of(as.character(pos_otu$predictor)))
one_mouse_pos_otus_df$human_source <- factor(one_mouse_pos_otus_df$human_source)

om_import_pos_otus <- data.frame(otu = colnames(select(one_mouse_pos_otus_df, -mouse_id, -log_cfu_med)))
om_pred_pos <- c()
om_rsq_pos <- c()
for(i in 1:iters){
    set.seed(i)
    train <- one_mouse_pos_otus_df %>% 
      group_by(human_source) %>% 
      sample_n(1) %>% ungroup() 
    test <- one_mouse_pos_otus_df %>% 
      filter(!mouse_id %in% train$mouse_id)
    for(m_try in 1:25){
      for(n_tree in seq(200, 2000, 100)){
    set.seed(seed)
    rf_om <- randomForest(log_cfu_med ~ ., data = select(train, -mouse_id),
                             importance = TRUE, ntree = n_tree, mtry = m_try)
    om_pred_pos <- rbind(om_pred_pos,
                     data.frame(select(test, mouse_id, log_cfu_med),
                          predicted=predict(rf_om, test),
                          iter = i,
                          rf_tree = n_tree,
                          rf_try = m_try))
    om_rsq_pos <- rbind(om_rsq_pos, c(iter = i,
                                      try = m_try,
                                      tree = n_tree,
                              mice = paste0(paste(train$mouse_id, collapse = ' '), '_', m_try, '_', n_tree), 
                              train_rsq = tail(rf_om$rsq,1),
                              test_rsq = 1 - (sum((test$log_cfu_med - predict(rf_om, test))^2)/
                                sum((test$log_cfu_med - mean(test$log_cfu_med))^2))))
    import_df <- importance(rf_om)
    colnames(import_df)[1] <- paste0(paste(train$mouse_id, collapse = ' '),'_', m_try, '_', n_tree)
    om_import_pos_otus <- merge(om_import_pos_otus, import_df, by.x = 'otu', by.y = 'row.names') %>% 
      select(-IncNodePurity)
    }}
}
om_rsq_pos_df <- data.frame(iter = as.numeric(om_rsq_pos[,dimnames(om_rsq_pos)[[2]]=='iter']),
                            try = as.numeric(om_rsq_pos[,dimnames(om_rsq_pos)[[2]]=='try']),
                            tree = as.numeric(om_rsq_pos[,dimnames(om_rsq_pos)[[2]]=='tree']),
                            mice = om_rsq_pos[,dimnames(om_rsq_pos)[[2]]=='mice'],
           train_rsq = as.numeric(om_rsq_pos[,dimnames(om_rsq_pos)[[2]]=='train_rsq']),
           test_rsq = as.numeric(om_rsq_pos[,dimnames(om_rsq_pos)[[2]]=='test_rsq']),
           stringsAsFactors = F)
om_pf_df <- om_rsq_pos_df

om_rsq_pos_overall <- 1 - (sum((om_pred_pos$log_cfu_med - om_pred_pos$predicted)^2)/
               sum((om_pred_pos$log_cfu_med - mean(om_pred_pos$log_cfu_med))^2))

om_pred_pos <- rename(om_pred_pos, observed = log_cfu_med)

all_otus_importance <- gather(om_import_pos_otus,OTU, import_val,-otu)[,-2]
all_otus_importance$votes <- ifelse(all_otus_importance$import_val > 0, 1, 0)
all_otus_importance <- data.frame(table(all_otus_importance[,-2]))
pos_otu <- all_otus_importance[(filter(all_otus_importance, votes == 1) %>% select(Freq) - 
                      filter(all_otus_importance, votes == 0) %>% select(Freq)) > 0, ]
pos_otu <- data.frame(predictor = pos_otu$otu[pos_otu$votes==1],
                      filter(pos_otu, votes == 1) %>% select(Freq) - 
                      filter(pos_otu, votes == 0) %>% select(Freq)) %>% 
              arrange(desc(Freq))

ggplot(om_rsq_pos_df, aes(x = try, y = test_rsq)) + 
  stat_summary(fun.y=median, geom="line", aes(group = iter)) + 
  stat_summary(fun.data = 'median_hilow') +
geom_line() + facet_wrap(~tree, nrow=4)

ggplot(filter(om_rsq_pos_df, try ==6), aes(x = tree, y = test_rsq)) + 
  stat_summary(fun.y=median, geom="line", aes(group = iter)) + 
  stat_summary(fun.data = 'median_hilow')
```

`r median(om_rsq_pos_df$train_rsq)`
`r median(om_rsq_pos_df$test_rsq)`
`r om_rsq_pos_overall`

OM > 0
> median(om_rsq_pos$train_rsq)
[1] 0.08652421
> median(om_rsq_pos$test_rsq)
[1] 0.5331836
> om_rsq_pos_overall
[1] 0.5534567

All mice top 10%
> median(om_rsq_pos$train_rsq)
[1] 0.07336261
> median(om_rsq_pos$test_rsq)
[1] 0.6070359
> om_rsq_pos_overall
[1] 0.633238


> median(om_rsq_pos_df$train_rsq)
[1] 0.05986871
> median(om_rsq_pos_df$test_rsq)
[1] 0.5898076
> `r om_rsq_pos_overall`
> om_rsq_pos_overall
[1] 0.6150207


one mouse - using top 10% of predictive features for all mice in the training set
optimal at
train 
  try = 10, tree = 600
test
  try = 6, tree = 600
but the test set has two groupings in performance. one around a Rsq 0.75, one at 0.5 and two iterations at 0.325


       mouse         high       low          med MeanDecreaseAccuracy MeanDecreaseGini
1      D_507 24.746833562  1.737270 20.102178345          24.73595607        8.4911043
2      C_596 23.285539876  1.001002 20.447905674          24.43000483        7.6690227
3      D_527 18.032458266  1.001002 15.500296401          18.71071088        4.9877513
4      A_566 12.032722269  0.000000 12.067340706          13.81516364        3.0119082
5      D_540 10.866644663  1.737270 12.253700494          13.61280464        2.2541893
6      C_516 11.047770210  1.001002 10.744008798          12.43936737        2.2192996
7      A_503 10.956589615  4.195038  6.774750778          10.79692514        2.2143605
8      A_526  7.778933002  0.000000  6.659309475           8.50216395        1.1996857
9    369_992 -0.875534077  3.932419  4.882427149           3.72993812        1.3625130
10   369_942 -0.596862323  1.417051  3.309012343           2.37657639        0.7644884
11  IN3_2318  1.043691934  2.664468  1.245180833           2.18825289        0.8340440
12  MOUT_896  2.014382262 -2.247333  1.336156704           2.17645115        0.8413007
13   430_920  1.549432277  0.000000  1.108030915           1.91835030        0.6586209
14  MOUT_568  0.666044064 -1.417051  1.909190798           1.75633167        0.7946055
15  IN3_2336 -0.217030290  0.000000  2.406333245           1.45691227        0.5817839
16   NP2_979  1.078030444  0.000000  1.206469792           1.43939415        0.6973072
17   OUTA_NT  0.697539079  1.417051  0.845326576           1.18172290        0.7653337
18   NP2_983 -0.727654094  1.001002  1.931180990           1.05707031        0.8507964
19 OUTA_2063  1.808105182 -1.417051 -0.047912339           0.89013348        0.7126412
20   430_307  0.261169822 -2.464320  1.107393946           0.67386593        0.7143389
21   430_964 -0.574499626  1.001002  1.123257626           0.56350353        0.4823411
22   369_939 -0.619215217  0.000000  1.274820050           0.56227756        0.5328745
23 OUT2_2510  0.009109248 -1.001002  0.721274725           0.37736881        0.6381838
24   OUT2_NT -0.430535085  0.000000  0.460746344           0.14766696        0.6223585
25  IN2_2613  0.000000000  0.000000  0.000000000           0.00000000        0.0000000
26  IN2_2629  0.000000000  0.000000  0.000000000           0.00000000        0.0000000
27  IN2_2673  0.000000000  0.000000  0.000000000           0.00000000        0.0000000
28  NP2_2630  0.000000000  0.000000  0.000000000           0.00000000        0.0000000
29   LINE_NT  1.730524126  0.000000 -1.610672526          -0.09130011        0.6774122
30   430_304  0.153756741 -2.008048 -0.653527605          -0.51088419        0.6561920
31 OUTA_2062 -0.244531023 -1.737270 -0.443149129          -0.70889274        0.7545123
32  LINE_978 -1.613030982  1.001002 -0.003319811          -1.09823532        0.5058066
33   369_331 -2.611303629  0.000000 -0.024601226          -1.37881023        0.6251534
34  LINE_MNT -0.399645816 -1.737270 -1.503302377          -1.75744745        0.5979079
35  LINE_188 -1.752110136 -1.001002 -1.104193541          -1.91010075        0.5634185
36    IN3_NT -2.122086607  0.000000 -1.213308576          -2.28278894        0.7106271
37 OUT2_2533 -1.443012131  0.000000 -2.212914984          -2.28741305        0.5829754

```{r}
om_tf_df$group_mean <- 'med'
om_tf_df$group_mean[om_tf_df$test_rsq > 0.65] <- 'high'
om_tf_df$group_mean[om_tf_df$test_rsq < 0.4] <- 'low'
mice_group <- filter(om_tf_df, try == 5, tree == 500) %>% 
  select(mice, group_mean)
mice_group$mice <- gsub('_\\d*_\\d*$', '', mice_group$mice)

mice_diff <- data.frame(matrix(rep(NA, nrow(mice_group)*length(unique(colonized_cfu$mouse_id))),
                               nrow=nrow(mice_group)))
colnames(mice_diff) <- unique(colonized_cfu$mouse_id)
for(i in 1:nrow(mice_diff)){
    mice_diff[i,] <- ifelse(colnames(mice_diff) %in% strsplit(mice_group$mice, ' ')[[i]], 0,1)
}
predict_rsq <- cbind(mice_group, mice_diff) %>% 
  select(-mice)
predict_rsq$group_mean <- factor(predict_rsq$group_mean)
rsq_grp_rf <- randomForest(predict_rsq[,-1],predict_rsq$group_mean, importance = T)
importance_rsq <- data.frame(mouse = dimnames(importance_rsq)[[1]],importance(rsq_grp_rf))
arrange(importance_rsq, desc(MeanDecreaseAccuracy))
str(importance_rsq)


```